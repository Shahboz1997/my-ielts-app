"use client"; 
import React, {useEffect, useRef, useState } from 'react';
import AnimatedScore from './components/AnimatedScore';
import Navbar from './components/Navbar';
import AuthModal from './components/AuthModal';
import axios from 'axios';
import { motion, AnimatePresence } from 'framer-motion';
import { ChevronUpIcon, PaperAirplaneIcon } from '@heroicons/react/24/solid';
import { jsPDF } from "jspdf";
import autoTable from "jspdf-autotable";
import Zoom from 'react-medium-image-zoom';
import 'react-medium-image-zoom/dist/styles.css';
import { DocumentArrowDownIcon, MagnifyingGlassIcon, CheckIcon} from '@heroicons/react/24/solid';
import { 
  SparklesIcon,ShareIcon, ClockIcon, TrashIcon, ArrowPathIcon, DocumentTextIcon, CheckCircleIcon,
  BeakerIcon, FireIcon, ChartBarIcon, ArrowDownTrayIcon, PlayIcon, PauseIcon,
  GlobeAltIcon, ChatBubbleLeftRightIcon, BoltIcon, AcademicCapIcon, 
  UsersIcon, BuildingLibraryIcon, BriefcaseIcon, HeartIcon, ScaleIcon, BookmarkIcon,
  SunIcon, MoonIcon, PhotoIcon, BookOpenIcon, Bars3Icon, XMarkIcon, SpeakerWaveIcon, StarIcon
} from '@heroicons/react/24/outline';
  const resetTask1 = () => {
    if (window.confirm("Очистить все данные для Task 1?")) {
      setEssayT1('');
      setPromptT1('Summarize the information by selecting and reporting the main features...');
      setResultT1(null);
      setImage(null);
      setIsDescribing(false);
    }
  };
  // Сброс только для Task 2
  const resetTask2 = () => {
    if (window.confirm("Очистить все данные для Task 2?")) {
      setEssayT2('');
      setPromptT2('');
      setResultT2(null);
      setIsAutoGenerated(false);
    }
  };
  // Глобальный сброс системы (оставляем для полной очистки)
  const systemReset = () => {
    if (window.confirm("ВНИМАНИЕ! Это удалит ВСЕ данные для обоих заданий. Продолжить?")) {
      setEssayT1(''); setEssayT2('');
      setPromptT1('Summarize the information...'); setPromptT2('');
      setResultT1(null); setResultT2(null);
      setImage(null);
      setTimerActive(false); setTimeLeft(3600);
  }
  };
  const Typewriter = ({ text, speed = 0.05 }) => {
    const characters = text ? text.split("") : [];

    const container = {
      hidden: { opacity: 0 },
      visible: {
        opacity: 1,
        transition: { 
          staggerChildren: speed, // Буквы появляются по очереди
        },
      },
    };

    const child = {
      hidden: { opacity: 0 },
      visible: { 
        opacity: 1,
        transition: { duration: 0.01 } // Быстрое проявление каждой буквы
      },
    };

    return (
      <motion.p 
        className="leading-relaxed"
        variants={container}
        initial="hidden"
        animate="visible"
      >
        {characters.map((char, index) => (
          <motion.span
    animate={{ opacity: [1, 1, 0, 0] }} // 1 (виден) -> 0 (скрыт)
    transition={{ 
      duration: 0.8, 
      repeat: Infinity, 
      times: [0, 0.5, 0.51, 1], // Резкое переключение на середине цикла
      ease: "linear"
    }}
    className="ml-1 inline-block w-[2px] h-[1em] bg-red-600"
  />

        ))}
      </motion.p>
    );
  };
  const AnalysisSkeleton = ({ darkMode }) => (
    <div className="animate-pulse space-y-6">
      <div className={`h-40 rounded-[2.5rem] ${darkMode ? 'bg-slate-800' : 'bg-slate-200'}`} />
      <div className={`h-64 rounded-[2.5rem] ${darkMode ? 'bg-slate-800' : 'bg-slate-200'}`} />
    </div>
  );
  // Удаление одного элемента
  // const deleteArchiveItem = (id) => {
  //   if (window.confirm("Удалить эту запись из истории?")) {
  //     setArchive(prev => prev.filter(item => item.id !== id));
  //   }
  // };
  
  // Скачивание отчета прямо из архива
  const downloadArchiveReport = (entry) => {
    // Временно подменяем данные для функции downloadReport или вызываем её с параметрами
    // Чтобы не ломать основную логику, передадим данные в функцию генерации напрямую
    const isT1 = entry.taskType === 'Task 1';
    
    // Мы вызываем универсальную функцию генерации, передавая данные из записи архива
    // Здесь используется логика вашей функции downloadReport, но данные берутся из entry.fullData
    generatePDFFromData({
      isT1,
      result: entry.fullData,
      essay: entry.essay,
      prompt: entry.prompt,
      image: entry.image || null
    });
  };
  const TypingTitle = ({ text }) => {
    // Защита: если текста нет, ничего не рендерим
    if (!text) return null;

    const characters = text.split("");
    
    const container = {
      hidden: { opacity: 0 },
      visible: {
        opacity: 1,
        transition: { staggerChildren: 0.03, delayChildren: 0.2 },
      },
    };

    const child = {
      visible: { 
        opacity: 1, 
        display: "inline-block", // Важно для корректного удаления узлов
        transition: { duration: 0.01 } 
      },
      hidden: { 
        opacity: 0,
        display: "inline-block" 
      },
    };

    return (
      <motion.span
    animate={{ opacity: [1, 0] }}
    transition={{ 
      duration: 0.8, 
      repeat: Infinity, 
      // Используем "linear" + "times" для имитации шагов
      ease: "linear",
      times: [0, 0.5, 0.5, 1] 
    }}
    className="ml-1 inline-block w-[2px] h-[1em] bg-red-600 align-middle"
  />
    );
  };
  export default function BandBoosterPro() {
  const [status, setStatus] = useState('idle'); 
    const CRITERIA_TIPS = {
    TR: { // Task Response
      low: "Focus on addressing all parts of the prompt. Ensure your position is clear throughout.",
      mid: "Good response. Try to develop your main ideas with more specific examples.",
      high: "Excellent task coverage. Work on the nuance of your supporting arguments."
    },
    CC: { // Coherence & Cohesion
      low: "Use more linking words and ensure each paragraph has one clear central topic.",
      mid: "Logical flow is good. Practice using a wider variety of cohesive devices.",
      high: "Flawless progression. Ensure paragraph transitions feel completely natural."
    },
    LR: { // Lexical Resource
      low: "Try to avoid repeating the same words. Use synonyms and topic-specific vocabulary.",
      mid: "Strong vocabulary. Focus on precise word choice (collocations) and less common terms.",
      high: "Sophisticated use of lexis. Watch out for rare spelling or formation slips."
    },
    GRA: { // Grammatical Range
      low: "Use a mix of simple and complex sentences. Check for basic punctuation errors.",
      mid: "Good control. Increase the frequency of error-free complex structures.",
      high: "Outstanding range. Focus on absolute precision in extremely complex sentences."
  }};
  const [essayT2, setEssayT2] = useState('');
  const [error, setError] = useState(''); // Состояние для хранения текста ошибки
  const [isAutoGenerated, setIsAutoGenerated] = useState(false);
  const [activeTab, setActiveTab] = useState('Topics');
  const [currentTopic, setCurrentTopic] = useState(null);
  const [essayT1, setEssayT1] = useState('');
  const [isSaved, setIsSaved] = useState(false);
  const [appliedCorrections, setAppliedCorrections] = useState([]);
  const [customKeyword, setCustomKeyword] = useState('');
  const UPGRADE_MAP = {
  'good': ['beneficial', 'advantageous', 'exemplary', 'vital'],
  'bad': ['detrimental', 'harmful', 'adverse', 'unfavorable'],
  'big': ['substantial', 'significant', 'considerable', 'vast'],
  'things': ['elements', 'aspects', 'factors', 'commodities'],
  'nowadays': ['in the contemporary era', 'currently', 'presently'],
  'money': ['financial resources', 'capital', 'revenue'],
  'think': ['maintain', 'argue', 'assert', 'postulate']
};
  const [credits, setCredits] = useState(10);           // Новое
  const [image, setImage] = useState(null);
  const [isImageCollapsed, setIsImageCollapsed] = useState(false);
  const [tooltipData, setTooltipData] = useState(null);
  const [loadingT1, setLoadingT1] = useState(false);
  const [loadingT2, setLoadingT2] = useState(false);
  const [isGenLoadingT1, setIsGenLoadingT1] = useState(false);
  const [loading, setLoading] = useState(false);
  const synonymMap = { "good": "excellent, superb", "bad": "atrocious, detrimental" };
  const [genLoading, setGenLoading] = useState(false);
  const [darkMode, setDarkMode] = useState(false);
  const [archive, setArchive] = useState([]);
  // Инициализируем пустые объекты (чтобы не было ошибки "not defined")
  const grammarMap = {};
  const linkingMap = {};
  const [timeLeft, setTimeLeft] = useState(3600);
  const highlightRef = useRef(null);
  const [promptT1, setPromptT1] = useState('');
  const [promptT2, setPromptT2] = useState('');
  const [appliedIndices, setAppliedIndices] = useState([]);
  const [timerActive, setTimerActive] = useState(false);
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const [isDescribing, setIsDescribing] = useState(false);
  const activeResultsRef = useRef(null);
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
  const [activeResultT1, setResultT1] = useState(null);
  const [activeResultT2, setResultT2] = useState(null);
  const [isAuthOpen, setIsAuthOpen] = useState(false);
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [lastSearchIndex, setLastSearchIndex] = useState(0);
  const [lastSearchWord, setLastSearchWord] = useState("");
  const [isFocused, setIsFocused] = useState(false);
  const WEAK_WORDS = [
  'good', 'bad', 'big', 'small', 'things', 'stuff', 'get', 'very', 
  'nowadays', 'money', 'people', 'think', 'believe', 'happy', 'sad'
];
  const EXCLUDED_WORDS = ['a','it', 'an','not','You','you', 'that', 
    'to', 'of', 'in', 'on', 'at', 'also', 'they', '', 
    'by', 'for', 'with', 'and', 'but', 'is', 'are', 'was', 'were'];
  const [searchState, setSearchState] = useState({ word: "", index: -1, count: 0, current: 0 });
  const TASK1_ASSETS = {
    "Line graph": [
      "https://ieltsmaterial.com/wp-content/uploads/2017/01/ieltsmaterial.com-bar-charts.png",
      // Ваша исправленная ссылка
    ],
    "Bar chart": [
      "https://ieltsmaterial.com/wp-content/uploads/2017/01/ieltsmaterial.com-bar-charts.png",
      "https://exam-english.ru/assets/uploads/152/Cambridge_ielts_1.png",
      "https://goltc.in/wp-content/uploads/2024/01/IELTS_Writing_Task_1_BarChart_Table-198-2-1024x971.png",
      "https://i0.wp.com/ieltscharlie.com/wp-content/uploads/2017/01/Test-3-task-1-graphs.jpg?ssl=1",
      "https://tse4.mm.bing.net/th/id/OIP.kybq8c-qxHhfIYnFmyUDcQHaGL?rs=1&pid=ImgDetMain&o=7&rm=3"
      
    ],
      "Line graph": [
      "https://th.bing.com/th/id/OIP.yTM3_a_ewLIbOM4mSEEAHgHaFS?o=7rm=3&rs=1&pid=ImgDetMain&o=7&rm=3",
      "https://tse1.mm.bing.net/th/id/OIP._XrgZIPq6eSEqmXh0GsFOgHaEK?w=1920&h=1080&rs=1&pid=ImgDetMain&o=7&rm=3",
      "https://tse3.mm.bing.net/th/id/OIP.trPw7UYbV2nNwu2n6hQ6sgHaEM?w=1024&h=579&rs=1&pid=ImgDetMain&o=7&rm=3",
      "https://etest.edu.vn/wp-content/uploads/2022/08/cac-dang-writing-task-1-ielts.jpg",
      "https://tse1.mm.bing.net/th/id/OIP.uBnmcCp2SAh4afEguIz5iQHaEv?w=624&h=399&rs=1&pid=ImgDetMain&o=7&rm=3"
    ],
    "Pie chart": [
      "https://thecatalyst.edu.vn/blogs/wp-content/uploads/2024/10/ielts-writing-task-1-pie-charts.jpg",
      "https://www.ielts-writing.info/images/graphs/IELTS_Writing_Task_1_PieGraph-172.png",
      "https://i.ytimg.com/vi/DPOCKokySAE/maxresdefault.jpg",
      "https://ielts-jonathan.com/wp-content/uploads/2021/02/INTODUCTION-TASK-1-PIE-CHARTS-IELTS.jpg",
      "https://ielts-up.com/images/lesson2t12.png"
    ],
    "Table": [
      "https://ieltsfocus.com/wp-content/uploads/2017/11/task-1-table.png",
      "https://www.aehelp.com/wp-content/uploads/2022/03/AE-1080x1080-1.jpg",
      "https://us.v-cdn.net/6026921/uploads/editor/du/rzevddjgsmus.jpg",
      "https://cloud.educaplay.com/recursos/175/5605271/imagen_1_1588167248.png",
      "https://anu.edu.vn/wp-content/uploads/2023/04/de-thi-ielts-writing-task-1-ngay-02022023.jpg"
    ],
  };
  // ФУНКЦИЯ ОБРАБОТКИ
  const handleSubmit = (e) => {
  e.preventDefault();
  setError(''); // Сбрасываем старые ошибки

  // Получаем данные из формы
  const formData = new FormData(e.target);
  const email = formData.get('email');
  const message = formData.get('message'); // Убедись, что у textarea есть name="message"

  // 1. Валидация Email
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    setError('Please enter a valid email address');
    return; // Останавливаем выполнение
  }

  // 2. Валидация длины сообщения
  if (message.length < 10) {
    setError('Message is too short (min. 10 characters)');
    return;
  }

  // Если всё ок — запускаем отправку
  setStatus('sending');

  setTimeout(() => {
    setStatus('success');
    e.target.reset(); // Очищаем поля формы
    setTimeout(() => setStatus('idle'), 3000);
  }, 1500);
  };
  // Вспомогательная переменная для текущего результата
  const scrollToEditor = () => {
    // Находим элемент ввода текста (убедитесь, что у вашего textarea или контейнера есть id="essay-input")
    const element = document.getElementById('essay-editor');
    if (element) {
      element.scrollIntoView({ behavior: 'smooth', block: 'start' });
     } else {
      // Если ID не задан, просто скроллим чуть ниже хедера
      window.scrollTo({ top: 600, behavior: 'smooth' });
     }
     };
  const activeResult = activeTab === 'Task 1' ? activeResultT1 : activeResultT2;
  const [highlightedWord, setHighlightedWord] = useState(null);
  const editorRef = useRef(null); // Реф для текстового поля
  const handleAnalyze = async (mode) => {
    // Выбираем нужный сеттер в зависимости от режима
    const setCurLoading = mode === 'task1' ? setLoadingT1 : setLoadingT2;
    
    setCurLoading(true); // Включаем загрузку только для текущего таска
    try {
      const payload = {
        analysisMode: mode,
        essay1: essayT1,
        essay2: essayT2,
        promptText: mode === 'task1' ? promptT1 : promptT2,
        image: mode === 'task1' ? image : null
      };

      const res = await axios.post('/api/check', payload);
      
      if (mode === 'task1') setResultT1(res.data);
      else setResultT2(res.data);
      
      if (typeof playSuccessSound === 'function') playSuccessSound();
    } catch (err) {
      console.error("Analysis Error:", err);
    } finally {
      setCurLoading(false); // Выключаем загрузку
    }
  };
  const saveToArchive = (taskType, result, essay, prompt, image) => {
    const newEntry = {
      id: Date.now(),
      date: new Date().toLocaleString(),
      topic: prompt.substring(0, 50),
      overall: result.overall_band,
      taskType: taskType, // 'Task 1' или 'Task 2'
      essay: essay,
      prompt: prompt,
      image: image, // Base64 картинка
      wordCount: essay.split(/\s+/).length,
      fullData: result // Сохраняем весь объект ответа ИИ
    };
    setArchive(prev => [newEntry, ...prev]);
  };
  
const replaceNext = (oldWord, newWord) => {
  const editor = editorRef.current;
  if (!editor || !oldWord || !newWord) return;

  const isT1 = activeTab === 'Task 1';
  const currentText = isT1 ? essayT1 : essayT2;
  const setText = isT1 ? setEssayT1 : setEssayT2;

  // 1. Берем индекс текущего выделенного слова из стейта
  let targetIndex = searchState.index;

  // 2. Если слово еще не было найдено или мы "потерялись", ищем первое вхождение
  if (targetIndex === -1 || searchState.word !== oldWord.toLowerCase().trim()) {
    const firstIdx = currentText.toLowerCase().indexOf(oldWord.toLowerCase().trim());
    if (firstIdx === -1) return alert("Word not found");
    targetIndex = firstIdx;
  }

  // 3. Создаем новый текст с заменой конкретно этого вхождения
  const before = currentText.substring(0, targetIndex);
  const after = currentText.substring(targetIndex + oldWord.length);
  const updatedText = before + newWord + after;

  // 4. Обновляем эссе
  setText(updatedText);

  // 5. После обновления текста — ищем следующее вхождение этого же слова
  setTimeout(() => {
    triggerHighlight(oldWord); 
  }, 50);
};
const triggerHighlight = (word) => {
  const editor = editorRef.current;
  if (!editor || !word) return;

  const text = activeTab === 'Task 1' ? essayT1 : essayT2;
  const lowerText = text.toLowerCase();
  const lowerWord = word.toLowerCase().trim();

  // 1. Находим все индексы вхождений этого слова в тексте
  const indices = [];
  let idx = lowerText.indexOf(lowerWord);
  while (idx !== -1) {
    indices.push(idx);
    idx = lowerText.indexOf(lowerWord, idx + 1);
  }

  if (indices.length === 0) {
    alert("Word not found in text");
    return;
  }

  // 2. Определяем, какой индекс выбрать (следующий или первый)
  let nextOccurrence = 0;
  if (searchState.word === lowerWord) {
    nextOccurrence = (searchState.current + 1) % indices.length;
  }

  const targetIndex = indices[nextOccurrence];

  // 3. Обновляем состояние для индикатора
  setSearchState({
    word: lowerWord,
    index: targetIndex,
    count: indices.length,
    current: nextOccurrence
  });

  // 4. Выделяем слово в редакторе
  editor.focus();
  editor.setSelectionRange(targetIndex, targetIndex + lowerWord.length);

  // 5. Рассчитываем скролл (учитываем переносы строк)
  const linesBefore = text.substring(0, targetIndex).split('\n').length;
  const lineHeight = parseInt(window.getComputedStyle(editor).lineHeight) || 24;

  editor.scrollTo({
    top: (linesBefore - 1) * lineHeight - 80,
    behavior: 'smooth'
  });

  // 6. Твоя визуальная подсветка (если используется)
  setHighlightedWord(word);
  setTimeout(() => setHighlightedWord(null), 2000);
};

const formatTime = (s) => `${Math.floor(s/60)}:${(s%60).toString().padStart(2, '0')}`;
const wordCount = (t) => t ? t.trim().split(/\s+/).filter(Boolean).length : 0;
const renderHighlightedText = (text, highlights, searchState) => { // Добавили searchState в аргументы
  if (!text) return text;

  const excludedWords = ['a', 'an', 'the', 'to', 'of', 'in', 'on', 'at', 'by', 'for', 'with'];
  
  // 1. Сначала обрабатываем обычные хайлайты (ошибки/связки)
  const sortedHighlights = highlights ? [...highlights].sort((a, b) => b.text.length - a.text.length) : [];
  let parts = [text];

  sortedHighlights.forEach((h) => {
    if (excludedWords.includes(h.text.toLowerCase().trim())) return;

    let newParts = [];
    parts.forEach((part) => {
      if (typeof part !== 'string') {
        newParts.push(part);
        return;
      }
      
      const regex = new RegExp(`(${h.text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      const segments = part.split(regex);
      
      segments.forEach((seg) => {
        if (seg && seg.toLowerCase() === h.text.toLowerCase()) {
          // ПРОВЕРКА: является ли этот хайлайт также целью поиска?
          const isSearchMatch = searchState?.word && seg.toLowerCase().trim() === searchState.word.toLowerCase().trim();

          newParts.push(
            <span 
              key={Math.random()} 
              className={`px-0.5 rounded cursor-help transition-all border-b-[3px] inline-block -mb-[1px] 
                ${isSearchMatch ? 'search-match bg-yellow-400/40 dark:bg-yellow-500/30' : ''} 
                ${h.type === 'linking' 
                  ? 'bg-blue-100/50 dark:bg-blue-900/40 border-blue-500 dark:border-blue-400 text-blue-900 dark:text-blue-200' 
                  : 'bg-red-100/50 dark:bg-red-900/40 border-red-500 dark:border-red-400 text-red-900 dark:text-red-200'
                }`}
              title={h.suggestion}
            >
              {seg}
            </span>
          );
        } else if (seg) {
          newParts.push(seg);
        }
      });
    });
    parts = newParts;
  });

  // 2. ВАЖНО: Если слово в поиске ЕСТЬ, но оно НЕ является ошибкой (его нет в highlights),
  // нам все равно нужно подсветить его классом search-match, чтобы сработал скролл.
  if (searchState?.word) {
    let finalParts = [];
    const searchRegex = new RegExp(`(${searchState.word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');

    parts.forEach((part) => {
      if (typeof part !== 'string') {
        finalParts.push(part);
        return;
      }

      const segments = part.split(searchRegex);
      segments.forEach((seg) => {
        if (seg && seg.toLowerCase() === searchState.word.toLowerCase().trim()) {
          finalParts.push(
            <span key={Math.random()} className="search-match bg-yellow-400/40 dark:bg-yellow-500/30 border-b-[3px] border-yellow-500 inline-block -mb-[1px]">
              {seg}
            </span>
          );
        } else if (seg) {
          finalParts.push(seg);
        }
      });
    });
    return finalParts;
  }

  return parts;
};
  // --- СБРОС ТОЛЬКО TASK 1 ---
  const resetTask1 = () => {
    if (window.confirm("Delete all Task 1 data? Your essay, chart, and analysis will be lost.")) {
      setEssayT1('');
      setPromptT1('Summarize the information by selecting and reporting the main features, and make comparisons where relevant.');
      setResultT1(null); // Очищаем результат именно первого задания
      setImage(null);    // Удаляем картинку/график
      // Если есть локальное хранилище для черновиков, можно очистить конкретный ключ
      // localStorage.removeItem('ielts_t1_draft');
    }
  };
  // --- СБРОС ТОЛЬКО TASK 2 ---
  const resetTask2 = () => {
    if (window.confirm("Delete all Task 2 data? Your essay, topic, and analysis will be lost.")) {
      setEssayT2('');
      setPromptT2('');
      setResultT2(null); // Очищаем результат именно второго задания
      setIsAutoGenerated(false); // Разблокируем поле ввода темы
      setCurrentTopic(null);
    }
  };
  // --- ВАШ ГЛОБАЛЬНЫЙ СБРОС (оставляем для полной очистки) ---
  const handleFullReset = () => {
    if (window.confirm("Are you sure? This will delete EVERYTHING.")) {
      setEssayT1(''); setEssayT2('');
      setPromptT1('Summarize the information...'); setPromptT2('');
      setResultT1(null); setResultT2(null);
      setImage(null);
      setCurrentTopic(null);
      setIsAutoGenerated(false);
      setTimeLeft(3600);
      setTimerActive(false);
    }
  };
  useEffect(() => {
    const saved = localStorage.getItem('ielts_archive_v5');
    if (saved) setArchive(JSON.parse(saved));
    const draft = localStorage.getItem('ielts_draft');
    if (draft) {
      const { t1, t2 } = JSON.parse(draft);
      setEssayT1(t1 || ''); setEssayT2(t2 || '');
    }
    }, []);
  useEffect(() => {
  setAppliedCorrections([]);
}, [activeResult]);
  useEffect(() => {
      localStorage.setItem('ielts_draft', JSON.stringify({ t1: essayT1, t2: essayT2 }));
    }, [essayT1, essayT2]);
    useEffect(() => {
  if (editorRef.current) {
    // Сбрасываем высоту, чтобы корректно рассчитать scrollHeight
    editorRef.current.style.height = 'auto';
    // Устанавливаем новую высоту (минимум 320px, максимум — сколько нужно)
    const newHeight = Math.max(320, editorRef.current.scrollHeight);
    editorRef.current.style.height = `${newHeight}px`;
    
    // Синхронизируем высоту слоя визуализации
    if (highlightRef.current) {
      highlightRef.current.style.height = `${newHeight}px`;
    }
  }
}, [essayT1, essayT2, activeTab]); // Срабатывает при смене вкладок или вводе текста
  useEffect(() => {
      let interval;
      if (timerActive && timeLeft > 0) interval = setInterval(() => setTimeLeft(p => p - 1), 1000);
      return () => clearInterval(interval);
    }, [timerActive, timeLeft]);
  useEffect(() => {
    // Устанавливаем время в зависимости от активной вкладки
    if (activeTab === 'Task 1') {
      setTimeLeft(20 * 60); // 20 минут в секундах
    } else if (activeTab === 'Task 2') {
      setTimeLeft(40 * 60); // 40 минут в секундах
    }
    setTimerActive(false); // Останавливаем таймер при смене задачи
  }, [activeTab]);
  // Для звука (можно использовать системный сигнал или короткий base64 звук)
  useEffect(() => {
  if (activeResult?.text) {
    setEssayText(activeResult.text);
  }
}, [activeResult]); // Следим за появлением результата

  const playAlertSound = () => {
    const context = new (window.AudioContext || window.AudioContext)();
    const oscillator = context.createOscillator();
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(440, context.currentTime); // Нота Ля
    oscillator.connect(context.destination);
    oscillator.start();
    oscillator.stop(context.currentTime + 0.1); // Короткий писк
  };
  useEffect(() => {
    // Если осталось 60 секунд и таймер активен
    if (timeLeft === 60 && timerActive) {
      playAlertSound();
    }
    // Если время вышло
    if (timeLeft === 0 && timerActive) {
      setTimerActive(false);
      playAlertSound();
      setTimeout(() => alert("Time is up! Please submit your task."), 100);
    }
  }, [timeLeft, timerActive]);
  useEffect(() => {
  const close = () => setTooltipData(null);
  window.addEventListener('click', close);
  return () => window.removeEventListener('click', close);
}, []);
  const clearArchive = async () => {
    if (!window.confirm("Are you sure you want to clear the entire archive?")) return;
    try {
      // 1. Оптимистичное обновление интерфейса (сразу очищаем экран)
     setArchive([]);
      // 2. Удаление из базы данных через API
      await axios.delete('/api/check');

      // 3. Полная очистка LocalStorage (проверь все возможные ключи)
      localStorage.removeItem('ielts_archive_v5');
      // На всякий случай удаляем старые версии, если они могли остаться
      localStorage.removeItem('ielts_archive'); 
      localStorage.removeItem('ielts_archive_v4');

      alert("Archive cleared successfully");
    } catch (e) {
      console.error("Delete error:", e);
      alert("Error clearing database. Please try again.");
      
      // Если API упало, можно вернуть данные в стейт, чтобы пользователь видел, что удаление не прошло
      // fetchArchive(); 
    }
  };
  const generateCustomTopic = async () => {
    if (!customKeyword.trim()) return alert("Keyword required");
    setGenLoading(true);
    try {
      const res = await axios.post('/api/check', { generateTopic: true, keyword: customKeyword });
      setCurrentTopic({ name: "AI Topic", q: res.data.question });
      setActiveTab('Task 2');
    } catch (e) { alert("Fail"); }
    finally { setGenLoading(false); }
  };
  const downloadReport = async (archiveEntry = null) => {
  try {
    // 1. ПОДГОТОВКА ДАННЫХ
    const entry = archiveEntry || null;
    const isT1 = entry ? (entry.taskType === 'Task 1') : (activeTab === 'Task 1');
    const result = entry ? entry.fullData : (isT1 ? resultT1 : resultT2); // Исправлено: используем resultT1/T2
    const essay = entry ? entry.essay : (isT1 ? essayT1 : essayT2);
    const chartImage = entry ? entry.image : (isT1 ? image : null);
    const promptText = entry ? entry.promptText : (isT1 ? promptT1 : promptT2);

    if (!result) return alert("Analysis data not found!");

    const doc = new jsPDF();
    const themeRed = [220, 38, 38];
    const themeDark = [15, 23, 42];
    const themeBlue = [37, 99, 235];
    const themeGreen = [15, 118, 110];
    const safeEssay = essay || "";

    const addWatermark = (pdf) => {
      pdf.saveGraphicsState();
      pdf.setGState(new pdf.GState({ opacity: 0.05 }));
      pdf.setTextColor(150, 150, 150);
      pdf.setFontSize(50);
      pdf.text("BANDBOOSTER OFFICIAL", 35, 150, { angle: 45 });
      pdf.restoreGraphicsState();
    };

    // --- ИСПРАВЛЕНО: Мапы создаются как обычные объекты (без useMemo) ---
    const grammarMap = {};
    if (result?.corrections) {
      result.corrections.forEach(c => {
        const cleanOriginal = c.original.toLowerCase().trim().replace(/[.,!?;:]/g, '');
        const words = cleanOriginal.split(/\s+/);
        words.forEach(word => {
          if (word.length > 0) {
            grammarMap[word] = { fixed: c.fixed, rule: c.rule || "Grammar" };
          }
        });
      });
    }

    const linkingMap = {};
    if (result?.analysis?.linking_words?.found) {
      result.analysis.linking_words.found.forEach(word => {
        const clean = word.toLowerCase().trim().replace(/[.,!?;:()]/g, '');
        if (clean) linkingMap[clean] = true;
      });
    }

    // --- СТРАНИЦА 1: ШАПКА И БАЛЛЫ ---
    addWatermark(doc);
    doc.setFillColor(...themeDark);
    doc.rect(0, 0, 210, 40, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(20);
    doc.text("IELTS EVALUATION REPORT", 20, 22);
    doc.setFontSize(9);
    doc.text(`CANDIDATE SUBMISSION: ${isT1 ? 'ACADEMIC TASK 1' : 'ESSAY TASK 2'}`, 20, 30);

    let y = 55;
    doc.setFillColor(248, 250, 252);
    doc.roundedRect(20, y, 170, 30, 4, 4, 'F');
    doc.setTextColor(...themeRed);
    doc.setFontSize(35);
    doc.text(`${result.overall_band}`, 35, y + 22);
    doc.setTextColor(...themeDark);
    doc.setFontSize(12);
    doc.text("OVERALL BAND SCORE", 75, y + 12);
    doc.setFontSize(8);
    doc.setTextColor(100, 116, 139);
    doc.text(`DATE: ${new Date().toLocaleDateString()} | STATUS: VERIFIED BY AI`, 75, y + 22);

    autoTable(doc, {
      startY: y + 40,
      head: [['Assessment Criteria', 'Band']],
      body: Object.entries(result.criteria || {}).map(([k, v]) => [
        k.replace(/_/g, ' ').toUpperCase(),
        v.score?.toString() || v.toString()
      ]),
      theme: 'striped',
      headStyles: { fillColor: themeDark, fontSize: 9 },
      styles: { fontSize: 9, cellPadding: 4 }
    });

    let currentY = (doc.lastAutoTable ? doc.lastAutoTable.finalY : 150) + 15;

    // Изображение
    if (isT1 && chartImage && typeof chartImage === 'string' && chartImage.startsWith('data:image')) {
      try {
        doc.setTextColor(...themeRed);
        doc.setFontSize(11);
        doc.text("Original Task Image:", 20, currentY);
        currentY += 5;
        const format = chartImage.includes('png') ? 'PNG' : 'JPEG';
        doc.addImage(chartImage, format, 20, currentY, 170, 70, undefined, 'FAST');
        currentY += 75;
      } catch (e) { currentY += 5; }
    }

    // Текст анализа
    doc.setTextColor(...themeRed);
    doc.setFontSize(11);
    doc.text(`${isT1 ? 'Task 1' : 'Task 2'} Analysis (Yellow=Error, Blue=Linker):`, 20, currentY);
    currentY += 8;

    doc.setFontSize(10);
    let currentX = 20;
    const wordsInEssay = safeEssay.split(/(\s+)/); // Исправлено имя переменной во избежание конфликта

    wordsInEssay.forEach(part => {
      const clean = part.toLowerCase().trim().replace(/[.,!?;:()]/g, '');
      const isError = grammarMap[clean];
      const isLink = linkingMap[clean];
      const wordWidth = doc.getTextWidth(part);

      if (currentX + wordWidth > 190) { currentX = 20; currentY += 6.5; }

      if (isError) {
        doc.setFillColor(255, 241, 144);
        doc.rect(currentX, currentY - 3.5, wordWidth, 5, 'F');
        doc.setDrawColor(...themeRed);
        doc.line(currentX, currentY - 1, currentX + wordWidth, currentY - 1);
        doc.setTextColor(0, 0, 0);
      } else if (isLink) {
        doc.setFillColor(219, 234, 254);
        doc.rect(currentX, currentY - 3.5, wordWidth, 5, 'F');
        doc.setTextColor(30, 58, 138);
      } else {
        doc.setTextColor(60, 60, 60);
      }

      doc.text(part, currentX, currentY);
      currentX += wordWidth;

      if (currentY > 275) { doc.addPage(); addWatermark(doc); currentY = 25; currentX = 20; }
    });

    // --- СТРАНИЦА 2: ТАБЛИЦЫ ---
    doc.addPage();
    addWatermark(doc);
    doc.setTextColor(...themeRed);
    doc.setFontSize(14);
    doc.text("Detailed Corrections & Explanations", 20, 20);

    autoTable(doc, {
      startY: 28,
      head: [['#', 'Mistake', 'Correction', 'Rule', 'Explanation']],
      body: result.corrections?.map((c, i) => [
        (i + 1).toString(), c.original, c.fixed, c.rule || 'Grammar', c.explanation || 'See rule'
      ]) || [["-", "No mistakes found", "-", "-", "-"]],
      theme: 'grid',
      headStyles: { fillColor: themeRed, fontSize: 8 },
      columnStyles: { 
        1: { textColor: [150, 0, 0], fontStyle: 'italic' }, 
        2: { textColor: themeGreen, fontStyle: 'bold' },
        4: { cellWidth: 70 }
      }
    });

    // Linking Words Table
    const totalW = safeEssay.split(/\s+/).filter(w => w.length > 0).length || 1;
    const linkersFound = result.analysis?.linking_words?.found?.length || 0;
    const isOverused = (linkersFound / totalW) * 100 > 7;

    let linkingY = doc.lastAutoTable.finalY + 15;
    doc.setTextColor(...themeBlue);
    doc.setFontSize(13);
    doc.text("Cohesion Analysis: Linking Words & Upgrades", 20, linkingY);

    if (isOverused) doc.setTextColor(220, 38, 38); else doc.setTextColor(15, 118, 110);
    doc.setFontSize(8);
    doc.text(isOverused ? "STATUS: CAUTION - Linker density is high." : "STATUS: SUCCESS - Optimal transitions.", 20, linkingY + 7);
    doc.setTextColor(60, 60, 60);

    const upgrades = { 'but': 'However', 'and': 'Moreover', 'so': 'Consequently', 'also': 'Additionally' };

    autoTable(doc, {
      startY: linkingY + 12,
      head: [['#', 'Current Linker', 'Level', 'Recommended Upgrade']],
      body: result.analysis?.linking_words?.found?.map((word, i) => [
        (i + 1).toString(), word, upgrades[word.toLowerCase()] ? "Basic" : "Advanced", upgrades[word.toLowerCase()] || "Appropriate"
      ]) || [["-", "None", "-", "-"]],
      theme: 'grid',
      headStyles: { fillColor: themeBlue, fontSize: 8 },
      columnStyles: { 3: { textColor: themeGreen, fontStyle: 'italic' } }
    });

    // --- МОДЕЛЬНЫЙ ОТВЕТ ---
    let modelY = doc.lastAutoTable.finalY + 15;
    if (modelY > 210) { doc.addPage(); addWatermark(doc); modelY = 25; }
    
    doc.setTextColor(15, 118, 110);
    doc.setFontSize(14);
    doc.text("Expert Model Answer:", 20, modelY);
    
    doc.setTextColor(40, 40, 40);
    doc.setFontSize(10);
    const splitModel = doc.splitTextToSize(result.suggested_rewrite || "Not available", 170);
    doc.text(splitModel, 20, modelY + 10);

    doc.save(`IELTS_Report_${isT1 ? 'T1' : 'T2'}_${new Date().getTime()}.pdf`);

  } catch (err) {
    console.error("PDF Error:", err);
    alert("Error generating PDF");
  }
};
  const handleImageUpload = async (fileOrUrl) => {
    setIsDescribing(true);
try {
  const isUrl = typeof fileOrUrl === 'string';
  let imageData;

  if (isUrl) {
    // Если это ссылка из TASK1_ASSETS
    imageData = fileOrUrl;
  } else {
    // Если это файл с компьютера
    imageData = await new Promise((resolve) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.readAsDataURL(fileOrUrl);
    });
  }

      setImage(imageData);

      // Запрос к API для описания
  const res = await axios.post('/api/check', { 
    describeImage: true, 
    image: imageData 
  });

  if (res.data.question) {
    setPromptT1(res.data.question);
    setIsAutoGenerated(true);
  }
  } catch (e) {
    console.error("Upload error:", e);
  } finally {
    setIsDescribing(false);
  }
  };
  // Исправленная функция генерации, которая теперь ВИДИТ handleImageUpload
  const saveCurrentToArchive = () => {
    // 1. Сначала определяем данные
  const currentEssay = activeTab === 'Task 1' ? essayT1 : essayT2;
  const currentPrompt = activeTab === 'Task 1' ? promptT1 : promptT2;
  const currentResult = activeTab === 'Task 1' ? activeResultT1 : activeResultT2;
    // 2. Проверка на пустоту
    if (!currentEssay || currentEssay.trim().length < 10) {
      alert("Essay is too short to save!");
      return;
    }

    // 3. ОБЪЯВЛЯЕМ объект ПЕРЕД использованием (важно для избежания ошибки ReferenceError)
  const newEntry = {
    id: Date.now(),
    date: new Date().toLocaleString(),
    taskType: activeTab,
    essay: currentEssay,
    question: currentPrompt || "No prompt provided",
    image: activeTab === 'Task 1' ? image : null,
    fullData: currentResult || null
  };
  try {
      // 4. Обновляем стейт и локальное хранилище
  const updated = [newEntry, ...archive];
  setArchive(updated);
  localStorage.setItem('ielts_archive_v5', JSON.stringify(updated));

  // 5. Визуальный эффект "Saved!"
  setIsSaved(true);
  setTimeout(() => setIsSaved(false), 2000); 
  
  console.log("Saved to archive successfully:", newEntry.id);
} catch (e) {
  console.error("Save error:", e);
  alert("Error saving to archive.");
}
  };
  const generateTask1Data = async () => {
    setIsGenLoadingT1(true);
  try {
  const categories = Object.keys(TASK1_ASSETS);
  const randomCat = categories[Math.floor(Math.random() * categories.length)];
  const assets = TASK1_ASSETS[randomCat];
  const randomUrl = Array.isArray(assets) ? assets[Math.floor(Math.random() * assets.length)] : assets;
  // Вызываем handleImageUpload, передавая URL
  await handleImageUpload(randomUrl);
  
  setActiveTab('Task 1');
  window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (e) {
      console.error(e);
    } finally {
      setIsGenLoadingT1(false);
    }
  };
  const speak = (text) => {
  if (typeof window !== 'undefined' && window.speechSynthesis) {
    window.speechSynthesis.cancel();
    const ut = new SpeechSynthesisUtterance(text);
    ut.lang = 'en-US';
    ut.rate = 0.85; // Чуть медленнее для учебных целей
    window.speechSynthesis.speak(ut);
  }
};
  // Определяем, какой результат сейчас активен
//const activeResult = activeTab === 'Task 1' ? resultT1 : resultT2;
// Заполняем карты, только если есть данные анализа
if (activeResult) {
  // Grammar Corrections
  activeResult.corrections?.forEach(c => {
    const words = c.original?.toLowerCase().split(/\s+/) || [];
    words.forEach(word => {
      const clean = word.replace(/[.,!?;:]/g, '');
      if (clean) grammarMap[clean] = { fixed: c.fixed, rule: c.rule };
    });
  });

  // Linking Words
  activeResult.analysis?.linking_words?.found?.forEach(word => {
    const clean = word.toLowerCase().replace(/[.,!?;:]/g, '');
    if (clean) linkingMap[clean] = true;
  });
}
  const sharedStyles = {
  fontFamily: 'inherit',
  fontSize: '16px',
  lineHeight: '1.8',
  padding: '24px 10px 24px 10px', // Единый паддинг для обоих слоев
  whiteSpace: 'pre-wrap',
  overflowWrap: 'break-word',
  wordBreak: 'break-word',
  fontVariantLigatures: 'none',
  boxSizing: 'border-box',
};
const handleScroll = (e) => {
  const { scrollTop, scrollLeft } = e.target;
  requestAnimationFrame(() => {
    if (highlightRef.current) {
      highlightRef.current.scrollTop = scrollTop;
      highlightRef.current.scrollLeft = scrollLeft;
    }
  });
};
// Замени свою 810 строку на эту:
const [essayText, setEssayText] = useState(activeResult?.text || "");
// Находим место, где у тебя стейты promptT1 и promptT2
const handleReplaceWord = (oldWord, newWord) => {
  const isT1 = activeTab === 'Task 1';
  const currentEssay = isT1 ? essayT1 : essayT2;
  
  if (!currentEssay || !oldWord) return;

  // 1. ЛОГИКА ЗАМЕНЫ ТЕКСТА (ваша текущая)
  const escaped = oldWord.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const regex = new RegExp(`\\b${escaped}\\b`, 'gi');
  const updatedText = currentEssay.replace(regex, (match) => {
    const isCapitalized = match.charAt(0) === match.charAt(0).toUpperCase();
    return isCapitalized 
      ? newWord.charAt(0).toUpperCase() + newWord.slice(1).toLowerCase()
      : newWord.toLowerCase();
  });

  // Обновляем текст эссе
  if (isT1) setEssayT1(updatedText); 
  else setEssayT2(updatedText);

  // 2. !!! КРИТИЧЕСКОЕ ИЗМЕНЕНИЕ: УДАЛЯЕМ ОШИБКУ ИЗ ОБЪЕКТА RESULT !!!
  // Это заставит grammarMap пересчитаться и уберет красную линию
  const setResult = isT1 ? setResultT1 : setResultT2;
  const currentResult = isT1 ? activeResultT1 : activeResultT2;

  if (currentResult?.corrections) {
    const updatedCorrections = currentResult.corrections.filter(
      c => c.original.toLowerCase() !== oldWord.toLowerCase()
    );
    
    // Сохраняем обновленный результат без этой ошибки
    setResult({
      ...currentResult,
      corrections: updatedCorrections
    });
  }

  // 3. Синхронизация интерфейса (высота и скролл)
  setTimeout(() => {
    if (editorRef.current) {
      editorRef.current.style.height = 'auto';
      const nextHeight = Math.max(320, editorRef.current.scrollHeight);
      editorRef.current.style.height = `${nextHeight}px`;
      if (highlightRef.current) highlightRef.current.style.height = `${nextHeight}px`;
    }
  }, 50);
};
// --- ЛОГИКА СКРОЛЛА И ЭФФЕКТОВ ---
const [showScrollTop, setShowScrollTop] = useState(false);
const [scrollProgress, setScrollProgress] = useState(0);
useEffect(() => {
  const handleScroll = () => {
    // Вычисляем процент прокрутки для кольца
    const totalHeight = document.documentElement.scrollHeight - window.innerHeight;
    const progress = (window.scrollY / totalHeight) * 100;
    setScrollProgress(progress);
    
    // Показываем кнопку, если прокрутили вниз на 400px
    setShowScrollTop(window.scrollY > 400);
  };

  window.addEventListener('scroll', handleScroll);
  return () => window.removeEventListener('scroll', handleScroll);
}, []);

const handleScrollToTop = () => {
  // 1. Звуковой эффект (мягкий клик)
  const audio = new Audio('https://assets.mixkit.co');
  audio.volume = 0.15;
  audio.play().catch(() => {}); // Игнорируем блокировку автоплея браузером

  // 2. Вибрация (Haptic Feedback) для смартфонов
  if (typeof window !== 'undefined' && window.navigator.vibrate) {
    window.navigator.vibrate(15); 
  }

  // 3. Плавный скролл к началу страницы
  window.scrollTo({ top: 0, behavior: 'smooth' });
};
const shareReport = async (entry) => {
  const reportId = entry.id; // ID из твоей базы данных (например, Supabase)
  const shareUrl = `${window.location.origin}/share/${reportId}`;

  // Используем Web Share API (стандарт 2026 для мобилок)
  if (navigator.share) {
    try {
      await navigator.share({
        title: `IELTS Band ${entry.fullData.overall_band} Report`,
        text: `Check out my IELTS writing analysis on BandBooster!`,
        url: shareUrl,
      });
    } catch (err) {
      console.log("User cancelled sharing");
    }
  } else {
    // Если браузер не поддерживает (десктоп), просто копируем в буфер
    await navigator.clipboard.writeText(shareUrl);
    alert("Public link copied to clipboard!");
  }
};
const playClickSound = () => {
  const audioCtx = new (window.AudioContext || window.AudioContext)();
  const oscillator = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();

  oscillator.type = 'sine'; // Мягкий щелчок
  oscillator.frequency.setValueAtTime(150, audioCtx.currentTime); // Низкая частота
  oscillator.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);

  gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); // Тихий звук
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);

  oscillator.connect(gainNode);
  gainNode.connect(audioCtx.destination);

  oscillator.start();
  oscillator.stop(audioCtx.currentTime + 0.1);
};
// Замените старое объявление wordCount на это:
const currentWordCount = (activeTab === 'Task 1' ? essayT1 : essayT2)?.trim().split(/\s+/).filter(Boolean).length || 0;
const targetWords = activeTab === 'Task 1' ? 150 : 250;
const progress = Math.min((currentWordCount / targetWords) * 100, 100);
const currentEssayText = activeTab === 'Task 1' ? essayT1 : essayT2;

const progressPercent = Math.min((currentWordCount / targetWords) * 100, 100);
const handleFindClick = () => {
  playClickSound?.();

  // 1. Находим все подсвеченные поиском слова в DOM
const matches = document.querySelectorAll('.search-match');
  
if (matches.length > 0) {
    // 2. Определяем индекс следующего элемента
    const nextIndex = (searchState.current + 1) % matches.length;

    // 3. Плавно скроллим к элементу
    matches[nextIndex].scrollIntoView({
      behavior: 'smooth',
      block: 'center', // Центрируем слово в области видимости
    });

    // 4. Обновляем состояние (чтобы счетчик 1/5 изменился на 2/5)
    setSearchState(prev => ({
      ...prev,
      current: nextIndex
    }));
  }
};
const insertLinkingWord = (word) => {
  if (typeof playClickSound === 'function') playClickSound();

  const textarea = editorRef.current;
  if (!textarea) return;

  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const currentText = activeTab === 'Task 1' ? essayT1 : essayT2;
  const setEssay = activeTab === 'Task 1' ? setEssayT1 : setEssayT2;

  const before = currentText.substring(0, start);
  const after = currentText.substring(end);

  // 1. Проверка на начало предложения (для заглавной буквы)
  const isStartOfSentence = /(^|[.!?])\s*$/.test(before);
  let processedWord = isStartOfSentence 
    ? word.charAt(0).toUpperCase() + word.slice(1) 
    : word.toLowerCase();

  // 2. Логика пунктуации:
  // Проверяем, есть ли запятая СЛЕВА и СПРАВА от места вставки
  const hasCommaBefore = /,\s*$/.test(before);
  const hasCommaAfter = /^\s*,/.test(after);

  // Чистим слово от лишних запятых, если они пришли из API/списка
  processedWord = processedWord.replace(/,/g, '').trim();

  // Формируем вставку:
  // - Пробел перед, если нужно
  // - Само слово
  // - Запятая, если её еще нет после слова
  const prefix = (before !== '' && !/\s$/.test(before) && !hasCommaBefore) ? ' ' : '';
  const suffix = hasCommaAfter ? '' : ', ';
  
  const formattedWord = `${prefix}${processedWord}${suffix}`;
  
  const newText = before + formattedWord + after.replace(/^\s+/, ''); // Убираем лишние пробелы впереди 'after'
  
  setEssay(newText);

  setTimeout(() => {
    textarea.focus();
    const newCursorPos = start + formattedWord.length;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    
    textarea.style.height = '320px';
    textarea.style.height = `${textarea.scrollHeight}px`;
    if (highlightRef.current) {
      highlightRef.current.style.height = `${textarea.scrollHeight}px`;
    }
  }, 10);
};
<AnimatePresence>
  {tooltipData && (
    <motion.div
      initial={{ opacity: 0, y: 10, scale: 0.95 }}
      animate={{ opacity: 1, y: -45, scale: 1 }} // Всплывает чуть выше слова
      exit={{ opacity: 0, scale: 0.95 }}
      style={{ 
        position: 'fixed', 
        left: tooltipData.x, 
        top: tooltipData.y, 
        zIndex: 100 
      }}
      className={`flex flex-wrap gap-1 p-2 rounded-2xl border shadow-2xl backdrop-blur-xl ${
        darkMode ? 'bg-slate-900/90 border-slate-800' : 'bg-white/90 border-slate-200'
      }`}
    >
      <div className="absolute -bottom-1 left-4 w-2 h-2 rotate-45 border-r border-b bg-inherit border-inherit" />
      {tooltipData.synonyms.length > 0 ? (
        tooltipData.synonyms.map(syn => (
          <button
            key={syn}
            onClick={() => {
              handleReplaceWord(tooltipData.word, syn);
              setTooltipData(null);
            }}
            className="px-3 py-1.5 text-[10px] font-black uppercase tracking-wider rounded-xl bg-indigo-600 text-white hover:bg-indigo-500 transition-all active:scale-90"
          >
            {syn}
          </button>
        ))
      ) : (
        <span className="text-[9px] px-2 text-slate-500 font-bold">No upgrades found</span>
      )}
    </motion.div>
  )}
</AnimatePresence>


return (
      <div className={`min-h-screen flex flex-col transition-all duration-500 ${darkMode ? 'bg-slate-950 text-white' : 'bg-slate-50 text-slate-900 overflow-y-hidden'}`}>
        {/* NAVBAR */}
          <>
          <Navbar 
          activeTab={activeTab}
          setActiveTab={setActiveTab}
          darkMode={darkMode}
          setDarkMode={setDarkMode}
          isMenuOpen={isMenuOpen}
          setIsMenuOpen={setIsMenuOpen}
          isLoggedIn={isLoggedIn}
          credits={credits}
          onLoginClick={() => setIsAuthOpen(true)} // Передаем функцию открытия
        />
        <AnimatePresence>
        {isAuthOpen && (
          <AuthModal 
            isOpen={isAuthOpen} 
            onClose={() => setIsAuthOpen(false)} 
            onLoginSuccess={() => {
              setIsLoggedIn(true);
              setIsAuthOpen(false);
            }}
          />
        )}
      </AnimatePresence>
          </>
          
    <main className="flex-1 max-w-7xl mx-auto w-full p-4 md:p-8">
    {activeTab === 'Topics' && (
              <div className="space-y-12 animate-in fade-in duration-700">
                {/* 1. Header */}
                  <header className="text-center space-y-4 mb-12">
      <h1 className="text-4xl md:text-6xl font-black tracking-tighter uppercase">
        Focus On <span className="text-red-600">Excellence</span>
      </h1>
      <p className="text-slate-500 max-w-xl mx-auto uppercase text-[10px] font-bold tracking-widest italic">
        Challenge your limits with AI-powered task generation
      </p>

      {/* Секция выбора пути */}
      <div className="pt-6 flex flex-col items-center gap-3">
        <div className="flex items-center gap-4 w-full max-w-md px-6">
          <div className="h-[1px] flex-1 bg-gradient-to-r from-transparent via-slate-200 dark:via-slate-800 to-transparent" />
          <span className="text-[9px] font-black uppercase tracking-[0.3em] text-slate-400">OR</span>
          <div className="h-[1px] flex-1 bg-gradient-to-r from-transparent via-slate-200 dark:via-slate-800 to-transparent" />
        </div>
        
        <p className="text-sm md:text-base font-medium text-slate-600 dark:text-slate-400 px-4">
          Already have a draft?{" "}
          <button 
            onClick={scrollToEditor}
            className="text-red-600 font-black hover:text-red-700 transition-colors cursor-pointer underline underline-offset-4 decoration-red-600/30 hover:decoration-red-600"
          >
            Proceed directly to Evaluation
          </button>
          {" "}or start writing below.
        </p>
      </div>
    </header>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mt-12 items-stretch">
      {/* --- 2. ACADEMIC TASK 1 LAB --- */}
      <motion.section
        initial={{ opacity: 0, x: -30 }}
        whileInView={{ opacity: 1, x: 0 }}
        viewport={{ once: true }}
        transition={{ duration: 0.6 }}
        className="flex flex-col space-y-4 md:space-y-6"
      >
        {/* Выровнял mt до 10px у обоих, чтобы карточки начинались на одной линии */}
        <h2 className="mt-[10px] text-xl md:text-2xl font-black flex items-center justify-center md:justify-start gap-2 uppercase tracking-tighter text-red-600">
          <div className="w-1.5 h-6 md:w-2 md:h-8 bg-red-600 rounded-full" />
          Task 1 Lab
        </h2>

        <div
          onClick={generateTask1Data}
          className={`group p-6 md:p-8 flex-1 min-h-[280px] md:min-h-[320px] rounded-[2rem] md:rounded-[2.5rem] cursor-pointer border-2 border-dashed transition-all flex flex-col items-center justify-center gap-4 md:gap-6 ${
            darkMode
              ? "bg-slate-900 border-slate-800 hover:border-red-600/50 hover:bg-slate-800/40"
              : "bg-red-50/30 border-red-200 hover:bg-red-50 hover:border-red-400"
          }`}
        >
          <div className="bg-white dark:bg-slate-800 p-4 md:p-5 rounded-2xl md:rounded-3xl shadow-sm transition-transform group-hover:scale-110">
            {isGenLoadingT1 ? (
              <ArrowPathIcon className="w-10 h-10 md:w-12 md:h-12 animate-spin text-red-600" />
            ) : (
              <ChartBarIcon className="w-10 h-10 md:w-12 md:h-12 text-red-600" />
            )}
          </div>

          <div className="text-center">
            


            <h3 className="font-black text-lg md:text-xl uppercase tracking-tight italic min-h-[1.5em]">
              <TypingTitle text="Generate Data Task" />
            </h3>
            <p className="text-[10px] md:text-[11px] text-slate-500 uppercase font-bold tracking-widest mt-1 md:mt-2">
              Charts, Graphs & Diagrams
            </p>
          </div>

          <button className="px-6 py-2 bg-red-600 text-white text-[10px] font-black uppercase rounded-full shadow-lg shadow-red-200 md:opacity-0 md:group-hover:opacity-100 transition-all md:translate-y-2 md:group-hover:translate-y-0">
            {isGenLoadingT1 ? "Generating..." : "Instant Launch"}
          </button>
        </div>
      </motion.section>

      {/* --- 3. ESSAY TASK 2 LAB --- */}
      <motion.section
        initial={{ opacity: 0, x: 30 }}
        whileInView={{ opacity: 1, x: 0 }}
        viewport={{ once: true }}
        transition={{ duration: 0.6, delay: 0.2 }}
        className="flex flex-col space-y-4 md:space-y-6"
      >
        {/* Исправил mt-[30px] на mt-[10px], чтобы убрать перекос */}
        <h2 className="mt-[10px] text-xl md:text-2xl font-black flex items-center justify-center md:justify-start gap-2 uppercase tracking-tighter text-red-600">
          <div className="w-1.5 h-6 md:w-2 md:h-8 bg-red-600 rounded-full" />
          Task 2 Lab
        </h2>

        <div
          className={`p-6 md:p-8 flex-1 min-h-[280px] md:min-h-[320px] rounded-[2rem] md:rounded-[2.5rem] border-2 border-dashed transition-all flex flex-col items-center justify-center gap-4 md:gap-6 ${
            darkMode ? "bg-slate-900 border-slate-800" : "bg-red-50/30 border-red-200"
          }`}
        >
          <div className="bg-white dark:bg-slate-800 p-4 md:p-5 rounded-2xl md:rounded-3xl shadow-sm">
            {genLoading ? (
              <ArrowPathIcon className="w-10 h-10 md:w-12 md:h-12 animate-spin text-red-600" />
            ) : (
              <SparklesIcon className="w-10 h-10 md:w-12 md:h-12 text-red-600" />
            )}
          </div>

          <div className="text-center space-y-4 w-full">
            <div>
              <h3 className="font-black text-lg md:text-xl uppercase tracking-tight italic min-h-[1.5em]">
                <TypingTitle text="Generate Essay Task" />
              </h3>
              <p className="text-[10px] md:text-[11px] text-slate-500 uppercase font-bold tracking-widest mt-1">
                Custom Topics & Prompts
              </p>
            </div>

            <div className="flex flex-col gap-3 w-full max-w-[240px] md:max-w-xs mx-auto">
              <input
                value={customKeyword}
                onChange={(e) => setCustomKeyword(e.target.value)}
                placeholder="Enter Keyword..."
                className={`px-4 py-2.5 md:py-3 rounded-xl border-2 outline-none text-center text-[11px] md:text-xs font-bold transition-all ${
                  darkMode
                    ? "bg-slate-950 border-slate-800 focus:border-red-600 text-white"
                    : "bg-white border-red-100 focus:border-red-600 shadow-inner"
                }`}
              />
              <button
                onClick={async () => {
                  setGenLoading(true);
                  try {
                    const res = await axios.post("/api/check", {
                      generateTopic: true,
                      keyword: customKeyword,
                    });
                    if (res.data.question) {
                      setPromptT2(res.data.question);
                      setIsAutoGenerated(true);
                      setActiveTab("Task 2");
                      window.scrollTo({ top: 0, behavior: "smooth" });
                    }
                  } catch (e) {
                    console.error(e);
                  } finally {
                    setGenLoading(false);
                  }
                }}
                disabled={genLoading}
                className="bg-red-600 text-white py-2.5 md:py-3 rounded-xl font-black uppercase text-[10px] tracking-widest shadow-lg shadow-red-200 hover:bg-red-700 active:scale-95 transition-all disabled:opacity-50"
              >
                {genLoading ? "Initializing..." : "Initialize Topic"}
              </button>
            </div>
          </div>
        </div>
      </motion.section>
    </div>

                </div>
    )}
    {(activeTab === 'Task 1' || activeTab === 'Task 2') && (
      <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div className="lg:col-span-8 space-y-6">
          <div className={`p-8 rounded-[3rem] shadow-2xl border ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-100'}`}>
            
            <div className="flex flex-col gap-6 mb-8">
      {/* Верхний ряд: Заголовок и Таймер */}
      <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4 sm:gap-6 pb-6 border-b border-slate-100 dark:border-slate-800/50">
  
  {/* ЛЕВАЯ ЧАСТЬ: Заголовок и индикатор (Всегда сверху слева) */}
  <div className="flex items-center justify-between lg:justify-start w-full lg:w-auto gap-4 shrink-0">
    <div className="space-y-1">
      <h2 className="text-2xl sm:text-3xl lg:text-4xl font-black uppercase tracking-tighter text-red-600 leading-none">
        {activeTab}
      </h2>
      <div className="h-1 w-full bg-red-600 rounded-full opacity-20" />
    </div>

    {/* Кнопка Clear Draft для мобилок (видима только до lg экрана рядом с заголовком) */}
    <div className="lg:hidden">
      <button 
        onClick={() => activeTab === 'Task 1' ? resetTask1() : activeTab === 'Task 2' ? resetTask2() : systemReset()}
        className="p-2 text-slate-400 hover:text-red-600 border border-dashed border-slate-200 dark:border-slate-800 rounded-xl transition-all"
        title="Clear Draft"
      >
        <TrashIcon className="w-5 h-5" />
      </button>
    </div>
  </div>

  {/* ЦЕНТРАЛЬНАЯ ЧАСТЬ: Кнопка Clear Draft (Скрыта на мобилках, видна на десктопе) */}
  <div className="hidden lg:flex flex-1 justify-center">
    <button 
      onClick={() => activeTab === 'Task 1' ? resetTask1() : activeTab === 'Task 2' ? resetTask2() : systemReset()}
      className="group flex items-center gap-2 px-5 py-2.5 text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 hover:text-red-600 transition-all border border-dashed border-slate-200 dark:border-slate-800 hover:border-red-500/50 hover:bg-red-50 dark:hover:bg-red-950/20 rounded-2xl"
    >
      <TrashIcon className="w-4 h-4 transition-transform group-hover:rotate-12" />
      <span>Clear Draft</span>
    </button>
  </div>

  {/* ПРАВАЯ ЧАСТЬ: Управление временем (Таймер) */}
  <div className="flex flex-row lg:flex-col items-center lg:items-end justify-between lg:justify-center w-full lg:w-auto bg-slate-50 dark:bg-slate-900/50 lg:bg-transparent p-3 lg:p-0 rounded-2xl border border-slate-100 lg:border-0 dark:border-slate-800">
    <div className="flex items-center gap-2">
      {/* Таймер */}
      <motion.div 
        animate={timeLeft > 0 && timeLeft <= 60 && timerActive ? {
          backgroundColor: ["#fef2f2", "#fee2e2", "#fef2f2"],
          scale: [1, 1.03, 1],
        } : {}}
        transition={{ repeat: Infinity, duration: 1 }}
        className={`flex items-center justify-center gap-3 px-4 h-11 min-w-[120px] rounded-2xl font-mono font-bold border transition-all duration-300 shadow-sm ${
          timeLeft <= 60 && timeLeft > 0
            ? 'text-red-600 border-red-500 bg-white shadow-red-200' 
            : 'text-slate-700 dark:text-slate-200 border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950'
        }`}
      >
        <ClockIcon className={`w-5 h-5 ${timeLeft <= 60 && timerActive ? 'animate-pulse text-red-600' : 'text-slate-400'}`} />
        <span className="text-lg tabular-nums tracking-tighter">
          {formatTime(timeLeft)}
        </span>
      </motion.div>

      {/* Кнопка Play/Pause */}
      <button 
        onClick={() => setTimerActive(!timerActive)} 
        className={`flex items-center justify-center w-11 h-11 rounded-2xl text-white shadow-xl transition-all active:scale-90 ${
          timerActive 
            ? 'bg-amber-500 shadow-amber-500/30 hover:bg-amber-600' 
            : 'bg-red-600 shadow-red-600/30 hover:bg-red-700'
        }`}
      >
        {timerActive ? (
          <PauseIcon className="w-6 h-6 fill-current"/>
        ) : (
          <PlayIcon className="w-6 h-6 ml-0.5 fill-current"/> 
        )}
      </button>
    </div>

  </div>
</div>
    </div>
    {activeTab === 'Task 1' && (
      <div className="sticky top-4 z-30 mb-8 space-y-4">
      {/* 1. Блок Графика с функцией Zoom */}
      <div className="group relative">
        <div className="block w-full border-2 border-dashed border-red-200 rounded-[2.5rem] p-4 text-center backdrop-blur-md bg-white/60 dark:bg-slate-900/60 shadow-sm hover:shadow-md transition-all duration-300 overflow-hidden">
          {image ? (
            <div className="relative inline-block w-full">
              {/* Анимированная линия сканирования (теперь внутри основного блока) */}
              {isDescribing && (
                <div className="absolute inset-0 z-20 overflow-hidden rounded-2xl pointer-events-none">
                  <div className="w-full h-1 bg-red-500 shadow-[0_0_15px_rgba(239,68,68,0.8)] animate-scan-line" />
                </div>
              )}
              <Zoom overlayBgColorEnd="rgba(0, 0, 0, 0.85)" transitionDuration={400}>
                <img 
                  src={image} 
                  className={`max-h-48 md:max-h-64 mx-auto rounded-2xl shadow-lg border-2 border-white dark:border-slate-800 cursor-zoom-in transition-all duration-500 ${
                    isDescribing ? 'opacity-50 grayscale blur-[2px]' : 'group-hover:scale-[1.01]'
                  }`} 
                  alt="Task 1 Graphic" 
                />
              </Zoom>
              {/* Кнопка смены изображения */}
              {!isDescribing && (
                <label className="absolute -bottom-2 left-1/2 -translate-x-1/2 bg-red-600 text-white text-[9px] font-black px-3 py-1 rounded-full uppercase cursor-pointer hover:bg-red-700 transition-colors shadow-lg whitespace-nowrap z-40">
                  <input 
                    type="file" 
                    hidden 
                    accept="image/*" 
                    onChange={(e) => {
                      const file = e.target.files?.[0];
                      if (file) handleImageUpload(file); // Вызов для локального файла
                      }} 
                  />
                    Click to Replace
                </label>
              )}
            </div>
          ) : (
            <label className="cursor-pointer space-y-2 block py-6">
              <input 
                type="file" 
                hidden 
                accept="image/*" 
                onChange={(e) => {
                  const file = e.target.files?.[0];
                  if (file) handleImageUpload(file);
                }} 
              />
              <PhotoIcon className="w-10 h-10 mx-auto text-red-300" />
              <p className="text-[11px] font-bold text-slate-500 uppercase tracking-tighter">Upload Diagram or Graph</p>
            </label>
          )}
        </div>
      </div>
      {/* 2. Блок Вопроса (Нижний элемент) */}
      <div className="animate-in fade-in slide-in-from-top-2 duration-500">
        {/* Сюда можно вставить ваш textarea для вопроса */}
      </div>
    </div>

    )}
      {activeTab === 'Task 2' && currentTopic && (
              <div className="mb-6 p-6 bg-red-50 dark:bg-red-900/10 rounded-3xl border border-red-100 dark:border-red-900/20 italic">
                <p className="text-[10px] font-black text-red-600 uppercase mb-2 tracking-widest">Selected Prompt:</p>
                <p className="text-lg font-bold">"{currentTopic.q}"</p>
              </div>
            )}
    <div className="mb-6 animate-in fade-in slide-in-from-top-4 duration-500">
      <div className={`p-3 sm:p-4 rounded-2xl sm:rounded-[1.5rem] border-2 border-dashed transition-colors ${
  darkMode ? 'border-slate-800 bg-slate-900/40' : 'border-red-100 bg-red-50/30'
}`}>
  {/* ХЕДЕР ПОЛЯ ВВОДА - МАКСИМАЛЬНО КОМПАКТНЫЙ */}
  <div className="flex justify-between items-center mb-1.5 px-1">
    <span className="text-[8px] sm:text-[9px] font-black text-red-600/80 uppercase tracking-widest">
      {activeTab} Topic:
    </span>
    <DocumentTextIcon className="w-3 h-3 text-red-300" />
  </div>

  {/* ПОЛЕ ВВОДА - МЕНЬШЕ ШРИФТ И ИНТЕРВАЛЫ */}
  <textarea
  value={activeTab === 'Task 1' ? promptT1 : promptT2}
  onChange={(e) => {
    // Авто-высота: сбрасываем и ставим scrollHeight
    e.target.style.height = 'auto';
    e.target.style.height = e.target.scrollHeight + 'px';
    
    if (activeTab === 'Task 1') setPromptT1(e.target.value);
    else setPromptT2(e.target.value);
  }}
  // Инициализация высоты при первом рендере
  ref={(el) => {
    if (el) {
      el.style.height = 'auto';
      el.style.height = el.scrollHeight + 'px';
    }
  }}
  className={`w-full bg-transparent outline-none 
    text-[13px] sm:text-sm
    font-semibold
    leading-relaxed
    italic resize-none transition-all
    placeholder:text-slate-300 scrollbar-hide
    overflow-hidden
    ${darkMode ? 'text-slate-200' : 'text-slate-700'}
  `}
  placeholder={activeTab === 'Task 1' ? "Describe the chart details here..." : "Enter the essay topic here..."}
/>
  {/* ПОДВАЛ - УБРАНА ЛИНИЯ ДЛЯ ЭКОНОМИИ МЕСТА */}
  <div className="mt-1 flex justify-end px-1">
    <p className="text-[7px] font-bold text-slate-400/60 uppercase italic tracking-tight">
      Grade depends on this prompt
    </p>
  </div>
</div>

    </div>
    {/* Контейнер редактора (без изменений, но с привязкой к активной вкладке) */}
   <div  className={`relative w-full group overflow-hidden rounded-[2.5rem] border transition-all duration-500 ${
  darkMode ? 'border-slate-800 bg-slate-950' : 'border-slate-200 bg-slate-50'
   }`}>

   {/* --- ПАНЕЛЬ СЧЕТЧИКА (Fixed Float) --- */}
  {/* z-40 и pointer-events-none позволяют печатать прямо "под" ним */}
  <div className="absolute top-4 right-4 z-40 pointer-events-none select-none p-[10px]">
  <div className={`flex flex-col items-center justify-center w-[50px] h-[55px] rounded-2xl border backdrop-blur-md transition-all duration-300 ${
    darkMode 
      ? 'bg-slate-900/80 border-slate-700/50 shadow-2xl shadow-black/40' 
      : 'bg-white/80 border-slate-200/60 shadow-lg shadow-slate-200/50'
  }`}>
    {/* Индикатор прогресса (точка) */}
    <div className={`w-1.5 h-1.5 rounded-full mb-1.5 transition-colors duration-300 ${
      currentWordCount < targetWords ? 'bg-orange-500' : 'bg-green-500 animate-pulse'
    }`} />
    
    <div className="flex flex-col items-center leading-none">
      <span className={`text-[14px] font-black tabular-nums tracking-tight ${darkMode ? 'text-slate-100' : 'text-slate-900'}`}>
        {currentWordCount}
      </span>
      {/* Разделительная линия */}
      <div className="h-[1px] w-6 bg-slate-400/20 my-1" />
      <span className="text-slate-400 font-bold text-[9px] tracking-tighter">
        {targetWords}
      </span>
    </div>
  </div>
</div>


  {/* --- ШКАЛА ПРОГРЕССА (Верхняя линия) --- */}
  <div className="absolute top-0 left-0 w-full h-[3px] bg-slate-200 dark:bg-slate-800 z-50">
    <div 
      className={`h-full transition-all duration-700 ease-out ${
        currentWordCount < targetWords ? 'bg-gradient-to-r from-red-500 to-orange-400' : 'bg-gradient-to-r from-green-500 to-emerald-400'
      }`}
      style={{ width: `${Math.min(100, (currentWordCount / targetWords) * 100)}%` }}
    />
  </div>

  {/* --- 1. СЛОЙ ВИЗУАЛИЗАЦИИ (Подложка) --- */}
  <div 
  ref={highlightRef}
  className="absolute inset-0 z-0 pointer-events-none select-none overflow-hidden"
  style={{ 
    ...sharedStyles, 
    color: 'transparent',
    width: '100%',
    minHeight: '320px',
    // КРИТИЧЕСКИЕ ПРАВКИ ДЛЯ СИНХРОНИЗАЦИИ:
    display: 'block',
     // Должно быть 1:1 как в textarea
    border: '1px solid transparent', // Имитирует невидимую рамку textarea
    fontVariantLigatures: 'none',    // Отключает слияние букв (fi, fl)
    letterSpacing: 'normal',        // Убирает микро-сдвиги шрифта
    WebkitFontSmoothing: 'antialiased',
  }}
>
  {((activeTab === 'Task 1' ? essayT1 : essayT2) || "")
    .split(/(\s+|[.,!?;:()])/) // Сохраняем пробелы и пунктуацию
    .map((part, i) => {
  // 1. Выводим пробелы и знаки препинания без стилей (сохраняем структуру)
  if (/^(\s+|[.,!?;:()])$/.test(part)) {
    return <span key={i}>{part}</span>;
  }

  const clean = part.toLowerCase().trim().replace(/[.,!?;:]/g, '');
  if (!clean) return <span key={i}>{part}</span>;

  // 2. Логика проверок (согласно вашим последним изменениям)
  const isExcluded = EXCLUDED_WORDS.includes(clean);
  const isWeak = !isExcluded && WEAK_WORDS.includes(clean);
  const grammarData = !isExcluded && grammarMap[clean];
  const isLinking = !isExcluded && linkingMap[clean];
  const isSearchMatch = searchState?.word && clean === searchState.word.toLowerCase().trim();

  let highlightStyle = "";
  let tooltip = "";

  // 3. ПРИОРИТЕТНОСТЬ СТИЛЕЙ (Не меняя логику)
  if (grammarData) {
    // Приоритет 1: Ошибки (Красное зачеркивание)
    highlightStyle = "bg-red-500/10 line-through decoration-red-500/80 decoration-[2px] text-red-500/40 decoration-skip-ink-none";
    tooltip = `Fix: ${grammarData.fixed} (${grammarData.rule})`;
  } else if (isLinking) {
    // Приоритет 2: Связки (Синее подчеркивание)
    highlightStyle = "border-b-[3px] border-blue-600/90 dark:border-blue-400 -mb-[3px]";
  } else if (isWeak) {
    // Приоритет 3: Слабые слова (Желтый пунктир по вашему CSS классу)
    // Добавлены Tailwind-аналоги вашего CSS для надежности
    highlightStyle = "weak-word-hint border-b-2 border-dashed border-yellow-500/50 text-orange-400/80";
    tooltip = "Weak Word: Consider using a more academic synonym for a higher score.";
  }
  if (isWeak && !grammarData) {
  highlightStyle = "weak-word-hint border-b-2 border-dashed border-yellow-500/50 cursor-pointer pointer-events-auto";
  tooltip = "Click to see academic upgrades";
}
  return (
  <span 
    key={i} 
    title={tooltip || undefined}
    onClick={(e) => {
      if (isWeak) {
        e.stopPropagation();
        const rect = e.target.getBoundingClientRect();
        setTooltipData({
          word: clean,
          x: rect.left,
          y: rect.top,
          synonyms: UPGRADE_MAP[clean] || []
        });
      }
    }}
    className={`inline transition-all duration-200 ${highlightStyle} ${
      isSearchMatch ? 'ring-2 ring-yellow-400 bg-yellow-400/20 rounded-sm' : ''
    }`}
  >
    {part}
  </span>
);
    }
    )}

</div>
  {/* --- 2. ВЕРХНИЙ СЛОЙ (Textarea) --- */}
    <textarea
    ref={editorRef}
    // Логика значения сохранена
    value={activeTab === 'Task 1' ? essayT1 : essayT2}
    onChange={(e) => {
      playClickSound?.();
      
      // Логика авто-высоты (сохранена)
      e.target.style.height = 'auto'; 
      const nextHeight = Math.max(320, e.target.scrollHeight);
      e.target.style.height = `${nextHeight}px`;

      // Синхронизация высоты подложки
      if (highlightRef.current) {
        highlightRef.current.style.height = `${nextHeight}px`;
      }

      if (activeTab === 'Task 1') setEssayT1(e.target.value);
      else setEssayT2(e.target.value);
    }}
    onFocus={(e) => {
      setIsFocused(true);
      e.target.style.height = 'auto';
      e.target.style.height = `${Math.max(320, e.target.scrollHeight)}px`;
    }}
    onBlur={() => setIsFocused(false)}
    
    // Плавная синхронизация скролла через вашу функцию handleScroll
    onScroll={handleScroll} 
    
    spellCheck="false"
    placeholder="Begin your essay..."
    className={`relative z-10 w-full min-h-[320px] bg-transparent outline-none resize-none overflow-hidden transition-colors duration-200
      ${darkMode 
        ? 'text-slate-100 caret-indigo-400 selection:bg-indigo-500/30' 
        : 'text-slate-900 caret-indigo-600 selection:bg-indigo-200/50'}`}
    style={{
      ...sharedStyles,
      // ВАЖНО: Эти отступы должны быть в точности как в highlightRef слое
      padding: '24px 10px 24px 10px',
      lineHeight: '1.8',
      WebkitFontSmoothing: 'antialiased',
      border: '1px solid transparent', // Чтобы не было сдвига относительно подложки
    }}
  />
</div>
</div>
    {activeResult && !loading && (
    <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-700 pb-10">
      
      {/* 1. Блок общего вердикта (Strategy) — Теперь с более ярким градиентом */}
      {/* 2. Сетка критериев (Scores & Feedback) */}
      <section className="space-y-4">
        <h3 className="text-[11px] font-black uppercase tracking-[0.3em] text-slate-500 dark:text-slate-400 ml-2">
          Criteria Breakdown
        </h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {Object.entries(activeResult.criteria || {}).map(([key, data]) => (
            <div key={key} className="p-6 rounded-[2rem] bg-white dark:bg-slate-900 border-2 border-slate-100 dark:border-slate-800 shadow-xl shadow-slate-200/50 dark:shadow-none flex flex-col group hover:border-red-500/50 transition-all duration-300">
              <div className="flex justify-between items-center mb-4">
                <span className="text-[11px] font-black uppercase tracking-wider text-slate-600 dark:text-slate-300 group-hover:text-red-600">
                  {key.replace(/_/g, ' ').replace('Task Achievement', 'TA').replace('Task Response', 'Task Response')}
                </span>
                <div className="bg-red-600 px-4 py-1.5 rounded-2xl shadow-lg shadow-red-600/20">
                  <span className="text-xl font-black text-white">{data.score}</span>
                </div>
              </div>
              <p className="text-[13px] leading-relaxed text-slate-700 dark:text-slate-300 font-medium italic pt-4 border-t border-slate-100 dark:border-slate-800">
                {data.comment}
              </p>
            </div>
          ))}
        </div>
      </section>
      {/* 3. Группировка детальных ошибок (Corrections) */}
      <div className="space-y-6">
  <h3 className="text-[11px] font-black uppercase tracking-[0.3em] text-slate-500 dark:text-slate-400 ml-2">
    Detailed Corrections
  </h3>
     <div className="grid grid-cols-1 gap-8">
  <AnimatePresence mode="popLayout">
    {activeResult.corrections && activeResult.corrections.length > 0 ? (
      activeResult.corrections.map((err, i) => {
        // Пропускаем рендер, если этот блок уже был применен
        if (appliedCorrections.includes(i)) return null;

        return (
          <motion.div 
            key={err.original + i}
            initial={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, x: 50, scale: 0.9, height: 0, marginBottom: 0 }}
            transition={{ duration: 0.4, ease: "circOut" }}
            layout
            className="group p-8 sm:p-10 rounded-[3.5rem] bg-white dark:bg-slate-900 border-2 border-slate-100 dark:border-slate-800 shadow-xl transition-all duration-500 hover:border-red-500/30 overflow-hidden"
          >
            <div className="flex flex-col lg:flex-row gap-10">
              {/* ЛЕВАЯ ЧАСТЬ: Оригинал и Исправление */}
              <div className="flex-1 space-y-8">
                <div className="space-y-3">
                  <span className="text-[10px] font-black text-red-600 uppercase px-3 py-1 bg-red-50 dark:bg-red-900/20 rounded-full border border-red-100 dark:border-red-800/30">
                    Original Text
                  </span>
                  <p className="text-[15px] sm:text-base font-bold text-slate-400 dark:text-slate-500 line-through italic decoration-red-500/40 leading-[1.8]">
                    {err.original}
                  </p>
                </div>

                <div className="space-y-4">
                  <div className="flex items-center justify-between gap-4">
                    <span className="text-[10px] font-black text-green-600 uppercase px-3 py-1 bg-green-50 dark:bg-green-900/20 rounded-full border border-green-100 dark:border-green-800/30">
                      Recommended Correction
                    </span>
                    <button 
                      onClick={() => speak(err.fixed)} 
                      className="group/btn p-2.5 rounded-2xl bg-slate-100 dark:bg-slate-800 hover:bg-green-500 transition-all active:scale-90 shadow-sm"
                    >
                      <svg xmlns="http://www.w3.org" viewBox="0 0 24 24" fill="currentColor" className="w-4 h-4 text-slate-400 group-hover/btn:text-white transition-colors">
                        <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.659 1.905h1.93l4.5 4.5c.945.945 2.561.276 2.561-1.06V4.06zM18.584 5.106a.75.75 0 011.06 0c3.808 3.807 3.808 9.98 0 13.788a.75.75 0 11-1.06-1.06 8.25 8.25 0 000-11.668.75.75 0 010-1.06z" />
                        <path d="M15.932 7.757a.75.75 0 011.061 0 4.5 4.5 0 010 6.364.75.75 0 01-1.06-1.06 3 3 0 000-4.242.75.75 0 010-1.062z" />
                      </svg>
                    </button>
                  </div>
                  <p className="text-lg sm:text-xl font-black text-slate-900 dark:text-white leading-[1.6]">
                    {err.fixed}
                  </p> 

                  {/* КНОПКА ЗАМЕНЫ С ФУНКЦИЕЙ СКРЫТИЯ */}
                  <button 
                    onClick={() => {
                      handleReplaceWord(err.original, err.fixed);
                      setAppliedCorrections(prev => [...prev, i]); // Скрываем блок
                    }}
                    className={`mt-4 group/apply flex items-center gap-3 px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-wider transition-all active:scale-95 shadow-lg
                      ${darkMode 
                        ? 'bg-indigo-600 hover:bg-indigo-500 text-white shadow-indigo-900/20' 
                        : 'bg-slate-900 hover:bg-indigo-600 text-white shadow-slate-300'
                      }`}
                  >
                    <span className="w-5 h-5 flex items-center justify-center bg-white/20 rounded-lg group-hover/apply:rotate-12 transition-transform">
                      <svg xmlns="http://www.w3.org" viewBox="0 0 20 20" fill="currentColor" className="w-3 h-3">
                        <path fillRule="evenodd" d="M15.312 11.424a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L9 13.586V4a1 1 0 012 0v9.586l1.899-1.899a1 1 0 011.413 0z" clipRule="evenodd" />
                      </svg>
                    </span>
                    Apply & Dismiss
                  </button>
                </div>
              </div>

              {/* ПРАВАЯ ЧАСТЬ (Оставляем без изменений) */}
              <div className="lg:w-[40%] flex flex-col justify-between p-7 sm:p-8 rounded-[2.5rem] bg-slate-50 dark:bg-slate-950/50 border border-slate-200 dark:border-slate-800 shadow-inner min-h-[280px]">
                <div className="space-y-4">
                  <div className="flex items-center justify-between gap-4 mb-2">
                    <div className="flex items-center gap-2">
                      <div className="w-2 h-2 bg-red-600 rounded-full animate-pulse" />
                      <span className="font-black uppercase text-[10px] text-red-600 tracking-widest">
                        Rule: {err.rule}
                      </span>
                    </div>
                    <span className="px-2 py-0.5 rounded-lg bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 text-[9px] font-black border border-purple-200 dark:border-purple-800">
                      {err.level || 'B2'}
                    </span>
                  </div>
                  <p className="font-semibold italic text-slate-800 dark:text-slate-200 leading-[1.7] text-[13px] sm:text-[14px]">
                    {err.explanation}
                  </p>
                </div>

                <div className="mt-6 pt-4 border-t border-slate-200 dark:border-slate-800">
                  <div className="flex justify-between items-center mb-2">
                    <span className="text-[9px] font-black text-slate-400 uppercase tracking-widest italic">Complexity Scale</span>
                    <span className="text-[9px] font-bold text-slate-500 uppercase italic">Mastery: {err.level === 'C2' ? 'Native' : 'Advanced'}</span>
                  </div>
                  <div className="flex gap-1 h-1">
                    {['A1', 'A2', 'B1', 'B2', 'C1', 'C2'].map((lvl) => (
                      <div 
                        key={lvl} 
                        className={`flex-1 rounded-full transition-all duration-500 ${
                          err.level === lvl || (lvl === 'B2' && !err.level) 
                            ? 'bg-red-500 shadow-[0_0_5px_rgba(239,68,68,0.5)] scale-y-150' 
                            : 'bg-slate-200 dark:bg-slate-800 opacity-30'
                        }`} 
                      />
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </motion.div>
        );
      })
    ) : (
      <p className="text-center text-slate-400 py-10 italic">No corrections found.</p>
    )}
  </AnimatePresence>
</div>
     </div>
      {/* 4. Suggested Rewrite — Теперь с ярким акцентом */}
      {activeResult.suggested_rewrite && (
        <div className="relative p-8 md:p-10 rounded-[3rem] bg-white dark:bg-slate-900 border-2 border-green-500/30 dark:border-green-500/20 shadow-[0_20px_50px_rgba(34,197,94,0.15)] dark:shadow-none overflow-hidden">
    
    {/* Декоративный фоновый элемент для сочности цвета на белом */}
    <div className="absolute top-0 right-0 w-32 h-32 bg-green-500/5 blur-[40px] rounded-full -mr-10 -mt-10" />

    <div className="relative z-10">
      <h4 className="text-[12px] font-black uppercase tracking-[0.3em] text-green-700 dark:text-green-400 mb-8 flex items-center gap-3">
        <div className="p-2 bg-green-600 rounded-xl shadow-lg shadow-green-600/30">
          <CheckCircleIcon className="w-5 h-5 text-white" />
        </div>
        Suggested Academic Rewrite
      </h4>

      <div className="relative px-2">
        {/* Крупные кавычки для акцента */}
        <span className="absolute -left-6 -top-4 text-6xl text-green-500/20 dark:text-green-500/10 font-serif select-none">
          “
        </span>
        
        <p className="text-[16px] md:text-[17px] leading-[1.9] text-slate-800 dark:text-slate-100 font-bold italic tracking-tight">
          {activeResult.suggested_rewrite}
        </p>
        
        <div className="mt-6 flex justify-end">
          <span className="text-[10px] font-black uppercase tracking-widest text-green-600/50">
            Perfected by AI Expert
          </span>
        </div>
      </div>
    </div>
  </div>

      )}
    </div>
      )}
    <div className="mt-8 flex flex-col gap-6">
      {/* Разделитель */}
      <div className="h-[1px] w-full bg-gradient-to-r from-transparent via-slate-200 dark:via-slate-800 to-transparent" />

      {/* Контейнер кнопок: на мобилках в колонку (или ряд), на десктопе по краям */}
    </div>
     <div className="flex flex-col sm:flex-row justify-between items-center gap-4 w-full">
        
        {/* ЛЕВАЯ КНОПКА: SAVE */}
        <div className="w-full sm:w-auto">
          <button 
            onClick={saveCurrentToArchive}
            disabled={isSaved}
            className={`w-full sm:w-auto group flex items-center justify-center gap-2 px-6 py-4 sm:py-3 text-[10px] font-black uppercase tracking-widest transition-all duration-300 rounded-2xl shadow-lg active:scale-95 ${
              isSaved 
                ? 'bg-green-600 text-white shadow-green-200 scale-105' 
                : 'bg-slate-900 dark:bg-slate-800 text-white hover:bg-black'
            }`}
          >
            {isSaved ? (
              <>
                <CheckCircleIcon className="w-4 h-4 animate-bounce" />
                <span>Saved!</span>
              </>
            ) : (
              <>
                <BookmarkIcon className="w-4 h-4 transition-transform group-hover:-translate-y-0.5 text-red-500" />
                <span>Save to Archive</span>
              </>
            )}
          </button>
        </div>

        {/* ПРАВАЯ КНОПКА: ANALYZE */}
        <div className="w-full sm:w-auto">
          <button 
            onClick={() => handleAnalyze(activeTab === 'Task 1' ? 'task1' : 'task2')} 
            disabled={activeTab === 'Task 1' ? loadingT1 : loadingT2} 
            className="w-full sm:px-10 py-4 text-xs md:text-sm bg-red-600 text-white rounded-2xl font-black uppercase flex items-center justify-center gap-3 shadow-xl shadow-red-200 dark:shadow-none transition-all active:scale-95 hover:bg-red-700 disabled:opacity-50"
          >
            {(activeTab === 'Task 1' ? loadingT1 : loadingT2) ? (
              <ArrowPathIcon className="w-5 h-5 animate-spin" />
            ) : (
              <SparklesIcon className="w-5 h-5 animate-pulse" />
            )}
            <span>{(activeTab === 'Task 1' ? loadingT1 : loadingT2) ? "Analyzing..." : "Analyze Essay"}</span>
          </button>
        </div>

      </div>
        </div>

        {/* Aside: Здесь также стоит добавить очистку или разделение баллов */}
         <aside className="lg:col-span-4 space-y-6" ref={activeResultsRef}>
      {!activeResult ? (
      // <div className="..."> Analysis Pending for {activeTab} </div>
        <div className={`h-80 border-2 border-dashed rounded-[3rem] flex flex-col items-center justify-center p-10 text-center transition-all ${darkMode ? 'border-slate-800 bg-slate-900/20 text-slate-600' : 'border-slate-200 bg-slate-50 text-slate-400'}`}>
    //       <div className="w-20 h-20 bg-white dark:bg-slate-800 rounded-full flex items-center justify-center mb-6 shadow-sm">
    //         <SparklesIcon className="w-10 h-10 opacity-30 text-red-600" />
    //       </div>
    //       <h5 className="text-[11px] font-black uppercase tracking-[0.3em] mb-2">Analysis Pending {activeTab}</h5>
    //       <p className="text-[10px] font-medium leading-relaxed max-w-[180px]">
    //         Submit your essay to receive instant AI feedback and band score.
    //       </p>
    //     </div>
      ) : (
             <motion.div
        initial={{ opacity: 0, y: 20 }} 
        animate={{ opacity: 1, y: 0 }} 
        className="space-y-6 lg:sticky lg:top-24 max-h-[calc(100vh-120px)] pr-2 custom-scrollbar no-scrollbar"
        >
          <div className="relative group overflow-hidden bg-slate-950 rounded-[3rem] p-1 shadow-2xl shadow-indigo-900/30">
  <div className="group relative z-10 rounded-[2rem] sm:rounded-[2.8rem] bg-gradient-to-br from-indigo-600 via-violet-600 to-fuchsia-800 p-5 sm:p-8 text-white shadow-2xl shadow-indigo-900/20">
    
    {/* Эффект блеска при наведении */}
    <div className="pointer-events-none absolute inset-0 translate-x-[-150%] bg-gradient-to-tr from-white/0 via-white/20 to-white/0 transition-transform duration-1000 group-hover:translate-x-[150%]" />

    <div className="relative z-20 flex flex-col gap-6">
      {/* ВЕРХНЯЯ ЧАСТЬ: Балл и Версия ИИ */}
      <div className="flex items-start justify-between gap-4">
        <div className="space-y-1">
          <div className="flex items-center gap-2">
            <span className="h-1.5 w-1.5 animate-pulse rounded-full bg-cyan-400 shadow-[0_0_8px_#22d3ee]" />
            <p className="text-[8px] font-black uppercase tracking-[0.3em] text-white/70 sm:text-[9px] sm:tracking-[0.4em]">
              Performance Index
            </p>
          </div>
          <h4 className="flex items-baseline font-black leading-none tracking-tighter text-[18vw] sm:text-7xl md:text-8xl">
            <AnimatedScore value={activeResult.overall_band} />
            <span className="ml-2 text-lg font-light opacity-30 sm:text-xl">/ 9.0</span>
          </h4>
        </div>

        <div className="shrink-0 rounded-xl border border-white/10 bg-slate-950/30 px-3 py-2 text-right backdrop-blur-md sm:px-4">
          <p className="text-[7px] font-black uppercase tracking-widest text-indigo-200 sm:text-[8px]">AI Engine</p>
          <p className="text-[9px] font-bold sm:text-[10px]">v4.2 PRO</p>
        </div>
      </div>
      {/* НИЖНЯЯ ЧАСТЬ: Кнопки управления */}
      <div className="flex flex-row items-stretch gap-2 mt-2">
        <button 
          onClick={() => downloadReport()}
          className="group/btn flex flex-1 items-center justify-center gap-2 rounded-2xl bg-slate-950 px-4 py-4 text-[9px] font-black uppercase tracking-[0.2em] text-white transition-all hover:bg-slate-900 hover:shadow-xl active:scale-[0.97] sm:gap-3 sm:rounded-[1.8rem] sm:py-5 sm:text-[10px] sm:tracking-[0.3em]"
        >
          <DocumentArrowDownIcon className="h-4 w-4 text-indigo-400 transition-transform group-hover/btn:translate-y-0.5 sm:h-5 sm:w-5" /> 
          <span className="whitespace-nowrap">Official PDF</span>
        </button>

        <button 
          onClick={() => shareReport(activeResult)} 
          className="flex aspect-square w-12 items-center justify-center rounded-2xl bg-white/10 text-white transition-all hover:bg-white/20 active:scale-90 sm:w-auto sm:px-5"
          title="Share Analysis"
        >
          <ShareIcon className="h-5 w-5" /> 
        </button>
      </div>
    </div>
  </div>

  {/* Background Decor */}
  <div className="absolute top-0 right-0 w-64 h-64 bg-indigo-400/10 blur-[100px] rounded-full -mr-20 -mt-20 pointer-events-none" />
</div>
          {/* --- 3. DEEP LINGUISTIC ANALYSIS --- */}
          <div className={`p-8 rounded-[3rem] border shadow-sm max-h-[600px] overflow-y-auto scrollbar-none [scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden
 ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
    <h5 className="text-[10px] font-black uppercase mb-6 tracking-[0.2em] text-red-600 sticky top-0 bg-inherit z-10 pb-2">
        Linguistic Insights
    </h5>
            <div className="space-y-6">
              
              {/* Linking Words Section */}
                <div className="space-y-5">
  {/* ЗАГОЛОВОК И БАЛЛ */}
  <div className="flex justify-between items-end border-b-[3px] border-blue-500/20 pb-2">
    <div className="flex items-center gap-2">
      <span className="h-2 w-2 rounded-full bg-blue-500 animate-pulse" />
      <span className="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">Linking Words</span>
    </div>
    <span className="text-[11px] font-black text-blue-600 bg-blue-100 dark:bg-blue-900/40 px-2 py-0.5 rounded-md italic">
      Score: {activeResult.analysis?.linking_words?.score}/9.0
    </span>
  </div>

  {/* СПИСОК НАЙДЕННЫХ СЛОВ */}
  <div className="flex flex-wrap gap-2">
    {activeResult.analysis?.linking_words?.found?.map((w, i) => (
      <button 
        key={i}
        onClick={() => triggerHighlight(w)}
        className={`group flex items-center gap-2 text-[10px] px-3 py-1.5 rounded-xl font-bold transition-all active:scale-95
          ${darkMode ? 'bg-slate-800 text-slate-300 hover:bg-slate-700' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}`}
      >
        {/* ИСПРАВЛЕНО: Теперь линия — это жирное подчеркивание текста, а не граница кнопки */}
        <span className="underline underline-offset-[4px] decoration-transparent group-hover:decoration-blue-500 decoration-[3px] transition-all">
          {w}
        </span>
        <MagnifyingGlassIcon className="w-3 h-3 opacity-0 group-hover:opacity-100 text-blue-500 transition-all transform group-hover:scale-110" />
      </button>
    ))}
  </div>

  {/* БЛОК ПРЕДЛОЖЕНИЙ */}
    <div className="p-5 rounded-[2.5rem] bg-blue-50/50 dark:bg-blue-950/20 border-2 border-blue-100 dark:border-blue-900/30">
  <p className="text-[9px] font-black uppercase text-blue-600 mb-4 tracking-[0.2em] flex items-center gap-2">
    <SparklesIcon className="w-3.5 h-3.5 animate-pulse" />
    <span className="underline underline-offset-[6px] decoration-blue-500/40 decoration-[3px]">
      Suggested Additions
    </span>
  </p>  
  <div className="flex flex-wrap gap-2">
  {(() => {
    const suggestions = activeResult.analysis?.linking_words?.suggestions;
    const hasSuggestions = suggestions && suggestions.length > 0;

    if (!hasSuggestions) {
      return (
        <span className="text-[10px] font-bold text-slate-400 italic py-1 px-2">
          Great flow! No extra suggestions needed.
        </span>
      );
    }

    return suggestions.map((s, i) => (
      <button 
        key={i} 
        onClick={() => insertLinkingWord(s)}
        className="group relative text-[9px] bg-white dark:bg-slate-800 text-blue-600 px-3 py-2.5 rounded-xl font-black shadow-sm border border-blue-100 dark:border-blue-800 hover:border-blue-500 hover:shadow-md active:scale-95 transition-all flex items-center gap-1.5"
        title={`Click to insert "${s}"`}
      >
        <span className="opacity-40 group-hover:text-blue-500 group-hover:opacity-100 transition-all font-bold">+</span>
        <span className="underline underline-offset-[2px] decoration-transparent group-hover:decoration-blue-500/50 decoration-2 transition-all">
          {s}
        </span>
      </button>
    ));
  })()}
</div>

    </div>

</div>


              {/* Repetitions List */}
              <div className="pt-4 border-t border-slate-100 dark:border-slate-800">
                <span className="text-[10px] font-black uppercase block mb-4 text-slate-400">Frequency Alert</span>
                  <div className="space-y-2">
  <AnimatePresence mode="popLayout">
    {activeResult?.analysis?.word_repetition?.map((item, i) => {
      const wordText = typeof item === 'object' ? item.word : item;
      const count = typeof item === 'object' ? item.count : 0;
      const synonyms = item.alternatives || []; 

      return (
        <motion.div
          key={wordText + i}
          layout
          initial={{ opacity: 0, x: -10 }}
          animate={{ opacity: 1, x: 0 }}
          exit={{ opacity: 0, scale: 0.95 }}
          className={`w-full p-4 rounded-2xl border transition-all mb-3 ${
            darkMode ? 'bg-slate-900/40 border-slate-800 shadow-none' : 'bg-white border-red-50 shadow-sm'
          }`}
        >
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
            {/* ИНФОРМАЦИЯ О СЛОВЕ */}
            <div className="flex items-center gap-2">
              <span className={`text-sm font-black uppercase tracking-tight ${darkMode ? 'text-slate-200' : 'text-slate-800'}`}>
                "{wordText}"
              </span>
              <span className="text-[10px] text-red-500 font-bold bg-red-100/20 px-2 py-0.5 rounded-full border border-red-500/10">
                {count}x repeated
              </span>
            </div>

            {/* ПОИСК ВХОЖДЕНИЙ */}
              <div className="flex items-center gap-3">
  <button 
    onClick={(e) => {
      e.preventDefault();
      if (typeof playClickSound === 'function') playClickSound();
      
      // 1. Запускаем вашу логику поиска
      triggerHighlight(wordText);

      // 2. Добавляем плавный скролл (с небольшой задержкой, чтобы DOM успел обновиться)
      setTimeout(() => {
        const matches = document.querySelectorAll('.search-match');
        if (matches.length > 0) {
          // Скроллим к текущему индексу (current) или к первому, если только начали
          const targetIndex = searchState.word === wordText.toLowerCase().trim() 
            ? (searchState.current + 1) % matches.length 
            : 0;

          matches[targetIndex].scrollIntoView({
            behavior: 'smooth',
            block: 'center', // Чтобы слово было в центре экрана, а не сверху
          });
        }
      }, 50); 
    }}
    className="group relative flex items-center gap-2 cursor-pointer select-none outline-none active:scale-95 transition-all py-1"
  >
    <div className="flex items-baseline gap-1">
      <span className={`
        text-[10px] font-black uppercase tracking-[0.15em] transition-all duration-200
        pb-0.5 border-b-[3px] 
        ${searchState.word === wordText.toLowerCase().trim() 
          ? 'text-red-600 border-red-600' 
          : 'text-slate-400 border-transparent group-hover:text-red-600 group-hover:border-red-600/50'}
      `}>
        Find
      </span>

      {searchState.word === wordText.toLowerCase().trim() && searchState.count > 0 && (
        <span className="ml-1 text-[10px] font-black tabular-nums text-red-600 animate-in fade-in zoom-in duration-300">
          {searchState.current + 1}
          <span className="mx-0.5 opacity-40">/</span>
          {searchState.count}
        </span>
      )}
    </div>

    <MagnifyingGlassIcon className={`
      w-3.5 h-3.5 transition-colors duration-200
      ${searchState.word === wordText.toLowerCase().trim() 
        ? 'text-red-600' 
        : 'text-slate-400 group-hover:text-red-600'}
    `} />
  </button>
</div>

          </div>

          {/* СЕКЦИЯ СИНОНИМОВ (UPGRADES) */}
          {synonyms.length > 0 && (
            <div className="mt-4 pt-3 border-t border-slate-100 dark:border-slate-800">
              <p className="text-[9px] font-black uppercase text-slate-400 mb-2 tracking-widest flex items-center gap-1">
                <SparklesIcon className="w-3 h-3 text-emerald-500" />
                Band 8.0+ Replacements:
              </p>
              <div className="flex flex-wrap gap-2">
                {synonyms.map((syn) => (
                  <button
                    key={syn}
                    onClick={() => replaceNext(wordText, syn)}
                    className={`flex items-center gap-1.5 text-[10px] px-3 py-1.5 rounded-xl font-bold transition-all hover:scale-105 active:scale-95 border ${
                      darkMode 
                        ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20 hover:bg-emerald-500/20 shadow-none' 
                        : 'bg-emerald-50 text-emerald-700 border-emerald-100 hover:bg-emerald-100 shadow-sm'
                    }`}
                  >
                    + {syn}
                  </button>
                ))}
              </div>
            </div>
          )}
        </motion.div>
      );
    })}
  </AnimatePresence>
</div>
  </div>
              {/* Integrity Badge */}
              {activeResult.plagiarism && (
                <div className={`mt-6 p-4 rounded-2xl border-l-4 ${activeResult.plagiarism.score > 30 ? 'bg-red-50 border-red-500' : 'bg-emerald-50 border-emerald-500'}`}>
                  <div className="flex justify-between items-center mb-1">
                    <span className="text-[9px] font-black uppercase text-slate-400">Plagiarism Check</span>
                    <span className="text-[9px] font-black uppercase text-slate-900">{activeResult.plagiarism.score}%</span>
                  </div>
                  <p className="text-[11px] font-bold text-slate-800">{activeResult.plagiarism.status}</p>
                </div>
              )}

            </div>
          </div>

        </motion.div>
      )}
      </aside>
     
      </div>
    )}
      {activeTab === 'Archive' && (
      <div className="max-w-4xl mx-auto space-y-4 sm:space-y-6 px-2 sm:px-0">
  {/* HEADER: Адаптивный заголовок и кнопка очистки */}
  <header className="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4 mb-6 sm:mb-10">
    <h2 className="text-3xl sm:text-4xl font-black italic tracking-tighter">
      Practice <span className="text-red-600">History</span>
    </h2>
    <button 
      onClick={clearArchive} 
      className="w-full sm:w-auto text-red-600 font-black uppercase text-[9px] sm:text-[10px] tracking-widest flex items-center justify-center gap-2 px-4 sm:px-6 py-3 rounded-xl sm:rounded-2xl bg-red-50 hover:bg-red-100 transition-all border border-red-100 active:scale-95 shadow-sm"
    >
      <TrashIcon className="w-3.5 h-3.5 sm:w-4 sm:h-4"/> 
      Destroy Archive
    </button>
  </header>
  
  {archive.length === 0 ? (
    <div className="text-center py-10 sm:p-20 opacity-20">
      <BookOpenIcon className="w-20 h-20 sm:w-32 sm:h-32 mx-auto text-red-600" />
    </div>
  ) : (
    <div className="grid gap-3 sm:gap-4">
      {archive.map(entry => (
        <div 
          key={entry.id} 
          className={`p-4 sm:p-6 rounded-[1.5rem] sm:rounded-[2.5rem] border flex flex-col md:flex-row justify-between items-center gap-4 transition-all hover:border-red-600 ${
            darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-100 shadow-xl'
          }`}
        >
          {/* ИНФОРМАЦИЯ: Балл и текст */}
          <div className="flex items-center gap-4 sm:gap-6 w-full md:w-auto">
            {/* BAND BADGE: Уменьшается на мобилках */}
            <div className="w-12 h-12 sm:w-14 sm:h-14 bg-red-600 text-white rounded-xl sm:rounded-2xl flex flex-col items-center justify-center font-black shadow-lg shrink-0">
              <span className="text-[7px] sm:text-[8px] opacity-60 uppercase leading-none">Band</span>
              <span className="text-lg sm:text-xl">
                {entry.fullData?.overall_band || "—"}
              </span>
            </div>  

            <div className="min-w-0 flex-1">
              <h4 className="font-black text-sm sm:text-lg uppercase leading-tight tracking-tight truncate max-w-[200px] sm:max-w-none">
                {entry.taskType}: {(entry.question || "No Topic").substring(0, 30)}...
              </h4>
              <p className="text-slate-400 text-[8px] sm:text-[10px] mt-1 sm:mt-2 font-bold uppercase tracking-wider italic">
                {entry.date || "Unknown Date"}
              </p>
            </div>
          </div>
          
          {/* КНОПКИ ДЕЙСТВИЯ: Группировка на мобилках */}
          <div className="flex items-center justify-between w-full md:w-auto gap-2 border-t md:border-0 pt-3 md:pt-0 border-slate-100 dark:border-slate-800">
            <div className="flex gap-2">
              <button 
                onClick={() => downloadReport(entry)} 
                className="p-3 sm:p-4 bg-slate-100 dark:bg-slate-800 rounded-xl sm:rounded-2xl hover:bg-red-600 hover:text-white transition-all shadow-sm"
                title="Download PDF"
              >
                <DocumentArrowDownIcon className="w-4 h-4 sm:w-5 sm:h-5" />
              </button>

              <button 
                onClick={() => {
                  if (window.confirm("Delete this entry?")) {
                    const updated = archive.filter(i => i.id !== entry.id);
                    setArchive(updated);
                    localStorage.setItem('ielts_archive_v5', JSON.stringify(updated));
                  }
                }} 
                className="p-3 sm:p-4 bg-red-50 text-red-600 rounded-xl sm:rounded-2xl hover:bg-red-600 hover:text-white transition-all active:scale-90"
              >
                <TrashIcon className="w-4 h-4 sm:w-5 sm:h-5" />
              </button>
            </div>

            <button 
              onClick={() => {
                if (entry.taskType === 'Task 1') {
                  setResultT1(entry.fullData); 
                  setEssayT1(entry.essay); 
                  if (entry.question) setPromptT1(entry.question); 
                  setActiveTab('Task 1');
                } else {
                  setResultT2(entry.fullData); 
                  setEssayT2(entry.essay); 
                  if (entry.question) setPromptT2(entry.question); 
                  setActiveTab('Task 2');
                }
                window.scrollTo({ top: 0, behavior: 'smooth' });
              }} 
              className="flex-1 md:flex-none px-4 sm:px-6 py-3 sm:py-4 bg-slate-100 dark:bg-slate-800 rounded-xl sm:rounded-2xl font-black uppercase text-[9px] sm:text-[10px] tracking-widest hover:bg-red-600 hover:text-white transition-all shadow-sm active:scale-95 text-center"
            >
              Review
            </button>
          </div>
        </div>
      ))}
    </div>
  )}
</div>
    )}
    </main>
      {/* FOOTER */}
        <footer className={`p-12 border-t mt-20 transition-all duration-500 ${darkMode ? 'bg-slate-950 border-slate-800 text-white' : 'bg-white border-slate-200 text-slate-900'}`}>
  <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-16">   
    {/* 1. Брендинг */}
    <div className="space-y-8">
      <div className="flex items-center gap-3 text-2xl font-black italic tracking-tighter group cursor-default">
        <div className="bg-red-600 p-2 rounded-xl rotate-3 group-hover:rotate-12 transition-transform">
          <FireIcon className="w-6 h-6 text-white" />
        </div>
        <span>BAND<span className="text-red-600">BOOSTER</span></span>
      </div>   
      <div className="relative group">
        <div className="absolute -inset-1 bg-gradient-to-r from-red-600 to-rose-600 rounded-3xl blur opacity-10 group-hover:opacity-20 transition duration-1000"></div>
        <div className={`relative p-6 rounded-3xl border ${darkMode ? 'bg-slate-900/40 border-slate-800' : 'bg-slate-50 border-slate-100 shadow-sm'}`}>
          <div className="flex items-center gap-2 mb-4">
            {[...Array(5)].map((_, i) => (
              <StarIcon key={i} className="w-3 h-3 text-red-600 fill-red-600" />
            ))}
          </div>
          <p className={`text-[12px] font-serif leading-relaxed italic ${darkMode ? 'text-slate-400' : 'text-slate-600'}`}>
            "This AI analysis is terrifyingly accurate. Finally hit Band 7.5 in writing!"
          </p>
          <div className="mt-4 flex items-center gap-3">
            <div className="w-6 h-1 bg-red-600 rounded-full"></div>
            <span className="text-[10px] font-black uppercase text-red-600 tracking-[0.2em]">Amara V.</span>
          </div>
        </div>
      </div>
    </div>

    {/* 2. Форма связи */}
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h5 className="text-[10px] font-black uppercase tracking-[0.3em] text-red-600">Improvement Hub</h5>
        <div className="h-px flex-1 bg-red-600/10 ml-4"></div>
      </div>
     <form 
  onSubmit={handleSubmit} // 1. ПРИВЯЗКА ФУНКЦИИ
  className="space-y-4 max-w-lg mx-auto"
>
  <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
    {/* ИМЯ */}
    <div className="relative group">
      <input 
        name="name" // 2. ДОБАВЛЕН NAME
        type="text" 
        placeholder="NAME*" 
        required 
        className={`w-full px-4 py-3 text-[11px] font-black uppercase tracking-wider rounded-xl border-2 outline-none transition-all
          ${darkMode 
            ? 'bg-slate-900/50 border-slate-800 text-white placeholder:text-slate-600 focus:border-red-600 focus:bg-slate-900' 
            : 'bg-slate-50 border-slate-100 text-slate-900 placeholder:text-slate-400 focus:border-red-600 focus:bg-white'
          }`} 
      />
    </div>

    {/* EMAIL */}
    <div className="relative group">
      <input 
        name="email" // 2. ДОБАВЛЕН NAME
        type="email" 
        placeholder="EMAIL*" 
        required 
        className={`w-full px-4 py-3 text-[11px] font-black uppercase tracking-wider rounded-xl border-2 outline-none transition-all
          ${darkMode 
            ? 'bg-slate-900/50 border-slate-800 text-white placeholder:text-slate-600 focus:border-red-600 focus:bg-slate-900' 
            : 'bg-slate-50 border-slate-100 text-slate-900 placeholder:text-slate-400 focus:border-red-600 focus:bg-white'
          }`} 
      />
    </div>
  </div>

  {/* СООБЩЕНИЕ */}
  <div className="relative group">
    <textarea 
      name="message" // 2. ДОБАВЛЕН NAME
      placeholder="HOW CAN WE MAKE BANDBOOSTER BETTER?*" 
      required 
      className={`w-full px-4 py-4 text-[11px] font-bold rounded-xl border-2 outline-none resize-none h-32 transition-all
        ${darkMode 
          ? 'bg-slate-900/50 border-slate-800 text-white placeholder:text-slate-600 focus:border-red-600 focus:bg-slate-900' 
          : 'bg-slate-50 border-slate-100 text-slate-800 placeholder:text-slate-400 focus:border-red-600 focus:bg-white'
        }`}
    ></textarea>
  </div>

  {/* ОШИБКИ И СТАТУС */}
  <AnimatePresence>
    {error && (
      <motion.div 
        initial={{ opacity: 0, y: -10 }}
        animate={{ opacity: 1, y: 0 }}
        exit={{ opacity: 0 }}
        className="p-3 mb-2 bg-red-600/10 border border-red-600/20 rounded-xl text-red-600 text-[10px] font-bold uppercase tracking-wider flex items-center gap-2"
      >
        <span className="w-1.5 h-1.5 bg-red-600 rounded-full animate-ping" />
        {error}
      </motion.div>
    )}
    
    {status === 'success' && (
      <motion.div 
        initial={{ opacity: 0, scale: 0.9 }}
        animate={{ opacity: 1, scale: 1 }}
        className="p-3 mb-2 bg-green-500/10 border border-green-500/20 rounded-xl text-green-500 text-[10px] font-bold uppercase tracking-wider text-center"
      >
        ✓ Suggestion Sent Successfully!
      </motion.div>
    )}
  </AnimatePresence>

  {/* КНОПКА */}
  <button 
    type="submit" 
    disabled={status === 'sending'}
    className={`w-full py-4 rounded-2xl text-[10px] font-black uppercase tracking-[0.3em] transition-all shadow-2xl active:scale-[0.98] disabled:opacity-50
      ${darkMode 
        ? 'bg-red-600 text-white hover:bg-red-500 shadow-red-900/20' 
        : 'bg-slate-950 text-white hover:bg-red-600 shadow-slate-300'
      }`}
  >
    {status === 'sending' ? 'Sending...' : 'Send Suggestion'}
  </button>
</form>
<AnimatePresence>
        {status === 'success' && (
          <motion.div 
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0.9 }}
            className="absolute inset-0 flex items-center justify-center z-10 backdrop-blur-[2px]"
          >
            <div className={`p-8 rounded-3xl shadow-2xl flex flex-col items-center gap-4 border-2
              ${darkMode ? 'bg-slate-900 border-red-600' : 'bg-white border-red-100'}`}
            >
              <div className="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center shadow-lg shadow-red-600/40">
                <CheckCircleIcon className="w-10 h-10 text-white" />
              </div>
              <div className="text-center">
                <h3 className={`font-black uppercase italic tracking-tighter text-xl ${darkMode ? 'text-white' : 'text-slate-950'}`}>Success!</h3>
                <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">Thank you for your feedback</p>
              </div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
    {/* 3. НАВИГАЦИЯ И ДАННЫЕ (Интегрировано) */}
    <div className="space-y-8">
      <div className="flex items-center justify-between">
        <h5 className="text-[10px] font-black uppercase tracking-[0.3em] text-red-600">Quick Links</h5>
        <div className="h-px flex-1 bg-red-600/10 ml-4"></div>
      </div>
      
      {/* Ссылки из NAV */}
      <div className="grid grid-cols-2 gap-2">
        {['Topics', 'Task 1', 'Task 2', 'Archive'].map((t) => (
          <button
            key={t}
            onClick={() => { setActiveTab(t); window.scrollTo({ top: 0, behavior: 'smooth' }); }}
            className={`text-left px-4 py-3 rounded-xl border text-[10px] font-black uppercase tracking-widest transition-all ${
              activeTab === t 
                ? 'bg-red-600 border-red-600 text-white shadow-lg' 
                : darkMode ? 'bg-slate-900 border-slate-800 text-slate-400 hover:border-red-600' : 'bg-slate-50 border-slate-100 text-slate-600 hover:border-red-600'
            }`}
          >
            {t}
          </button>
        ))}
      </div>

      <div className={`p-6 rounded-3xl border-l-8 border-red-600 ${darkMode ? 'bg-slate-900/50 border-slate-800' : 'bg-slate-50 border-slate-100'}`}>
        <p className="text-[11px] leading-relaxed font-bold uppercase tracking-tight opacity-60">
          Independent AI tool. v4.2 PRO. Updated: 2026.
        </p>
      </div>

      <div className="flex items-center gap-4">
        <div className={`w-10 h-10 rounded-full flex items-center justify-center ${darkMode ? 'bg-slate-800' : 'bg-slate-100'}`}>
          <ChatBubbleLeftRightIcon className="w-5 h-5 text-red-600" />
        </div>
        <div>
          <p className="text-[9px] font-black uppercase tracking-widest text-slate-400">Direct Contact</p>
          <a href="mailto:sashabilov@gmail.com" className="text-sm font-black hover:text-red-600">sashabilov@gmail.com</a>
        </div>
      </div>
    </div>
  </div>
  <AnimatePresence>
  {showScrollTop && (
    <motion.div
      initial={{ opacity: 0, scale: 0.5, y: 20 }}
      animate={{ opacity: 1, scale: 1, y: 0 }}
      exit={{ opacity: 0, scale: 0.5, y: 20 }}
      className="fixed bottom-8 right-8 z-[100] flex items-center justify-center group"
    >
      <span className="absolute right-full mr-4 px-3 py-1 bg-slate-900 text-white text-[10px] font-black uppercase tracking-widest rounded-lg opacity-0 group-hover:opacity-100 transition-all pointer-events-none">
        Back to top
      </span>
      <button
        onClick={handleScrollToTop}
        className={`relative p-4 rounded-2xl flex items-center justify-center transition-all active:scale-90 shadow-2xl ${
          darkMode ? 'bg-slate-900 text-white shadow-black/60' : 'bg-white text-red-600 shadow-red-200/60 border border-red-50'
        }`}
      >
        <svg className="absolute inset-0 w-full h-full -rotate-90 p-0.5">
            <circle 
              cx="50%" cy="50%" r="46%" 
              fill="transparent" 
              stroke="currentColor" 
              strokeWidth="2" 
              className={darkMode ? 'text-slate-800' : 'text-slate-100'} 
            />
            <motion.circle
              cx="50%" cy="50%" r="46%" 
              fill="transparent" 
              stroke="#ef4444" 
              strokeWidth="2" 
              // ИСПРАВЛЕНО: strokeLinecap вместо strokeDashcap
              strokeLinecap="round" 
              style={{ pathLength: scrollProgress / 100 }}
              transition={{ type: "spring", stiffness: 60, damping: 15 }}
            />
          </svg>
        <ChevronUpIcon className="w-6 h-6 relative z-10 group-hover:-translate-y-1 transition-transform" />
      </button>
    </motion.div>
  )}
</AnimatePresence>
        </footer>

{/* КНОПКА НАВЕРХ */}

      </div>
    );
  }
